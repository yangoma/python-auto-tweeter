<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 0.25rem;
        }
        .status-connected { color: #28a745; }
        .status-disconnected { color: #dc3545; }
        .tab-content { min-height: 500px; }
        .product-card {
            transition: transform 0.2s;
            cursor: pointer;
            border: 1px solid #dee2e6;
        }
        .product-card:hover {
            transform: translateY(-2px);
            border-color: #667eea;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .product-card .card-title {
            color: #2c3e50;
            font-weight: 600;
        }
        .product-card .card-text {
            color: #495057;
        }
        .product-card .text-muted {
            color: #6c757d !important;
        }
        .generation-progress {
            display: none;
        }
        .alert-dismissible {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1070;
            min-width: 300px;
            max-width: 400px;
        }
        .sheet-selector {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .sheet-tab {
            cursor: pointer;
            padding: 0.5rem 1rem;
            margin-right: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 0.25rem;
            background: #fff;
            color: #495057;
            transition: all 0.2s;
        }
        .sheet-tab:hover {
            background: #e9ecef;
            color: #212529;
        }
        .sheet-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1rem;
        }
        .product-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 0.375rem;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }
        .product-image-placeholder {
            width: 100%;
            height: 200px;
            background: linear-gradient(45deg, #f8f9fa 25%, transparent 25%, transparent 75%, #f8f9fa 75%), 
                        linear-gradient(45deg, #f8f9fa 25%, transparent 25%, transparent 75%, #f8f9fa 75%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            border: 1px solid #e9ecef;
        }
        .product-meta {
            font-size: 0.75rem;
            color: #6c757d;
        }
        .product-badges {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }
        .product-description {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white">
                            <i class="bi bi-robot"></i>
                            Auto Tweeter
                        </h4>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="bi bi-speedometer2"></i>
                                ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/bots">
                                <i class="bi bi-robot"></i>
                                ãƒœãƒƒãƒˆç®¡ç†
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/twitter">
                                <i class="bi bi-twitter"></i>
                                Twitteré€£æº
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/sheets">
                                <i class="bi bi-table"></i>
                                ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/posts">
                                <i class="bi bi-chat-square-text"></i>
                                æŠ•ç¨¿å±¥æ­´
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/analytics">
                                <i class="bi bi-graph-up"></i>
                                åˆ†æ
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="bi bi-table"></i>
                        ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆé€£æº
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="checkConnection()">
                                <i class="bi bi-arrow-clockwise"></i>
                                æ¥ç¶šç¢ºèª
                            </button>
                        </div>
                    </div>
                </div>

                <!-- æ¥ç¶šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-google" style="font-size: 2rem; margin-right: 1rem;"></i>
                                        <div>
                                            <h5 class="mb-1">Google Sheets API</h5>
                                            <p class="mb-0" id="connection-status">æ¥ç¶šã‚’ç¢ºèªä¸­...</p>
                                            <small class="text-muted" id="spreadsheet-info"></small>
                                        </div>
                                    </div>
                                    <div>
                                        <button class="btn btn-primary me-2" onclick="showConfigModal()" id="config-btn">
                                            <i class="bi bi-gear"></i>
                                            è¨­å®š
                                        </button>
                                        <i class="bi bi-circle-fill" id="status-indicator" style="font-size: 1.5rem;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                <ul class="nav nav-tabs" id="sheetsTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button" role="tab">
                            <i class="bi bi-calendar-event"></i>
                            æŠ•ç¨¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="affiliate-tab" data-bs-toggle="tab" data-bs-target="#affiliate" type="button" role="tab">
                            <i class="bi bi-cart"></i>
                            ã‚¢ãƒ•ã‚£ãƒªå•†å“ç®¡ç†
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="generation-tab" data-bs-toggle="tab" data-bs-target="#generation" type="button" role="tab">
                            <i class="bi bi-robot"></i>
                            AIæŠ•ç¨¿ç”Ÿæˆ
                        </button>
                    </li>
                </ul>

                <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                <div class="tab-content" id="sheetsTabContent">
                    <!-- æŠ•ç¨¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ– -->
                    <div class="tab-pane fade show active" id="schedule" role="tabpanel">
                        <div class="card mt-3">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-calendar-event"></i>
                                    äºˆç´„æŠ•ç¨¿ç®¡ç†
                                </h5>
                                <div>
                                    <button class="btn btn-success btn-sm me-2" onclick="syncFromSheets()">
                                        <i class="bi bi-arrow-down"></i>
                                        ã‚·ãƒ¼ãƒˆã‹ã‚‰åŒæœŸ
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="syncToSheets()">
                                        <i class="bi bi-arrow-up"></i>
                                        ã‚·ãƒ¼ãƒˆã¸åŒæœŸ
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="scheduled-posts-table">
                                    <div class="text-center py-4">
                                        <i class="bi bi-arrow-clockwise"></i>
                                        èª­ã¿è¾¼ã¿ä¸­...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ã‚¢ãƒ•ã‚£ãƒªå•†å“ç®¡ç†ã‚¿ãƒ– -->
                    <div class="tab-pane fade" id="affiliate" role="tabpanel">
                        <!-- ã‚·ãƒ¼ãƒˆé¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <div class="sheet-selector mt-3">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <label class="form-label mb-2">
                                        <i class="bi bi-table"></i>
                                        <strong>èª­ã¿è¾¼ã‚€ã‚·ãƒ¼ãƒˆå</strong>
                                    </label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="sheet-name-input" 
                                               value="ã‚¢ãƒ•ã‚£ãƒªç”¨ãƒ‡ãƒ¼ã‚¿" placeholder="ã‚·ãƒ¼ãƒˆåã‚’å…¥åŠ›">
                                        <button class="btn btn-primary" onclick="loadProductsFromSheet()">
                                            <i class="bi bi-download"></i>
                                            èª­ã¿è¾¼ã¿
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label mb-2">
                                        <strong>ã‚ˆãä½¿ã†ã‚·ãƒ¼ãƒˆ</strong>
                                    </label>
                                    <div class="d-flex flex-wrap" id="sheet-tabs">
                                        <span class="sheet-tab active" onclick="selectSheet('ã‚¢ãƒ•ã‚£ãƒªç”¨ãƒ‡ãƒ¼ã‚¿')">ã‚¢ãƒ•ã‚£ãƒªç”¨ãƒ‡ãƒ¼ã‚¿</span>
                                        <span class="sheet-tab" onclick="selectSheet('å•†å“ãƒã‚¹ã‚¿ãƒ¼')">å•†å“ãƒã‚¹ã‚¿ãƒ¼</span>
                                        <span class="sheet-tab" onclick="selectSheet('æ–°å•†å“')">æ–°å•†å“</span>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label mb-2">
                                        <strong>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</strong>
                                    </label>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-outline-info btn-sm" onclick="createSampleSheets()">
                                            <i class="bi bi-file-plus"></i>
                                            ã‚µãƒ³ãƒ—ãƒ«ä½œæˆ
                                        </button>
                                        <button class="btn btn-outline-success btn-sm" onclick="addCustomSheet()">
                                            <i class="bi bi-plus"></i>
                                            ã‚·ãƒ¼ãƒˆè¿½åŠ 
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-cart"></i>
                                    å•†å“ä¸€è¦§ <span class="badge bg-secondary" id="product-count">0</span>
                                </h5>
                                <div>
                                    <span class="text-muted me-3" id="current-sheet-name">ã‚·ãƒ¼ãƒˆ: ã‚¢ãƒ•ã‚£ãƒªç”¨ãƒ‡ãƒ¼ã‚¿</span>
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshProducts()">
                                        <i class="bi bi-arrow-clockwise"></i>
                                        æ›´æ–°
                                    </button>
                                </div>
                            </div>
                            <div class="card-body">
                                <div id="affiliate-products">
                                    <div class="text-center py-4">
                                        <i class="bi bi-cart" style="font-size: 3rem; color: #6c757d;"></i>
                                        <p class="mt-2 text-muted">ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦å•†å“ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„</p>
                                        <button class="btn btn-primary" onclick="loadProductsFromSheet()">
                                            <i class="bi bi-download"></i>
                                            å•†å“ã‚’èª­ã¿è¾¼ã‚€
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AIæŠ•ç¨¿ç”Ÿæˆã‚¿ãƒ– -->
                    <div class="tab-pane fade" id="generation" role="tabpanel">
                        <!-- ä½¿ç”¨æ–¹æ³•ã‚¬ã‚¤ãƒ‰ -->
                        <div class="alert alert-info mt-3">
                            <h6><i class="bi bi-info-circle"></i> AIæŠ•ç¨¿ç”Ÿæˆã®ä½¿ç”¨æ–¹æ³•</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>ğŸ“ å˜ä½“æŠ•ç¨¿ç”Ÿæˆ:</strong>
                                    <ol class="small mb-2">
                                        <li>ã‚¢ãƒ•ã‚£ãƒªå•†å“ç®¡ç†ã‚¿ãƒ–ã§å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿</li>
                                        <li>ç”Ÿæˆè¨­å®šã§LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨ãƒˆãƒ¼ãƒ³ã‚’é¸æŠ</li>
                                        <li>å•†å“ã‚’é¸æŠã—ã¦ã€Œå˜ä½“æŠ•ç¨¿ç”Ÿæˆã€ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                                        <li>ç”Ÿæˆã•ã‚ŒãŸæŠ•ç¨¿å†…å®¹ã‚’ç¢ºèªãƒ»ç·¨é›†</li>
                                    </ol>
                                </div>
                                <div class="col-md-6">
                                    <strong>ğŸš€ ä¸€æ‹¬æŠ•ç¨¿ç”Ÿæˆ:</strong>
                                    <ol class="small mb-2">
                                        <li>å•†å“ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª</li>
                                        <li>ç”Ÿæˆè¨­å®šã‚’èª¿æ•´</li>
                                        <li>ã€Œä¸€æ‹¬æŠ•ç¨¿ç”Ÿæˆã€ã§å…¨å•†å“ã®æŠ•ç¨¿ã‚’è‡ªå‹•ç”Ÿæˆ</li>
                                        <li>24æ™‚é–“å¾Œã‹ã‚‰1æ™‚é–“é–“éš”ã§äºˆç´„æŠ•ç¨¿ã¨ã—ã¦ç™»éŒ²</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">
                                            <i class="bi bi-gear"></i>
                                            ç”Ÿæˆè¨­å®š
                                        </h5>
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="openLLMConfigModal()">
                                            <i class="bi bi-tools"></i>
                                            LLMè¨­å®š
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <form id="generation-form">
                                            <div class="mb-3">
                                                <label class="form-label">LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼</label>
                                                <select class="form-select" id="provider">
                                                    <option value="openai">OpenAI</option>
                                                    <option value="ollama">Ollama (ãƒ­ãƒ¼ã‚«ãƒ«)</option>
                                                    <option value="claude">Claude</option>
                                                    <option value="gemini">Gemini</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">æŠ•ç¨¿ã‚¿ã‚¤ãƒ—</label>
                                                <select class="form-select" id="post-type">
                                                    <option value="promotional">ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³</option>
                                                    <option value="informational">æƒ…å ±æä¾›</option>
                                                    <option value="engaging">ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆé‡è¦–</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤</label>
                                                <input type="text" class="form-control" id="target-audience" value="general" placeholder="ä¾‹: 20ä»£å¥³æ€§, ITã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢">
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label">ãƒˆãƒ¼ãƒ³</label>
                                                <select class="form-select" id="tone">
                                                    <option value="friendly">ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼</option>
                                                    <option value="professional">ãƒ—ãƒ­ãƒ•ã‚§ãƒƒã‚·ãƒ§ãƒŠãƒ«</option>
                                                    <option value="casual">ã‚«ã‚¸ãƒ¥ã‚¢ãƒ«</option>
                                                    <option value="exciting">ã‚¨ã‚­ã‚µã‚¤ãƒ†ã‚£ãƒ³ã‚°</option>
                                                </select>
                                            </div>
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="include-hashtags" checked>
                                                    <label class="form-check-label" for="include-hashtags">
                                                        ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã‚’å«ã‚ã‚‹
                                                    </label>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="mb-0">
                                            <i class="bi bi-play-circle"></i>
                                            ç”Ÿæˆå®Ÿè¡Œ
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label">å•†å“é¸æŠ</label>
                                            <select class="form-select" id="selected-product">
                                                <option value="">å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                                            </select>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-primary" onclick="generateSinglePost()">
                                                <i class="bi bi-magic"></i>
                                                å˜ä½“æŠ•ç¨¿ç”Ÿæˆ
                                            </button>
                                            <button type="button" class="btn btn-success" onclick="generateBatchPosts()">
                                                <i class="bi bi-collection"></i>
                                                ä¸€æ‹¬æŠ•ç¨¿ç”Ÿæˆ
                                            </button>
                                            <button type="button" class="btn btn-outline-info" onclick="diagnoseGenerationSettings()">
                                                <i class="bi bi-search"></i>
                                                è¨­å®šè¨ºæ–­
                                            </button>
                                            <button type="button" class="btn btn-outline-warning" onclick="testOllamaConnection()">
                                                <i class="bi bi-wifi"></i>
                                                Ollamaæ¥ç¶šãƒ†ã‚¹ãƒˆ
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="showDebugLogs()">
                                                <i class="bi bi-terminal"></i>
                                                ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³
                                            </button>
                                            <button type="button" class="btn btn-outline-primary" onclick="testGenerationProcess()">
                                                <i class="bi bi-gear"></i>
                                                ç”Ÿæˆãƒ†ã‚¹ãƒˆ
                                            </button>
                                            <button type="button" class="btn btn-success" onclick="quickOllamaTest()">
                                                <i class="bi bi-lightning"></i>
                                                Ollamaç°¡å˜ãƒ†ã‚¹ãƒˆ
                                            </button>
                                        </div>
                                        <div class="mt-3">
                                            <small class="text-muted">
                                                <strong>ä½¿ç”¨æ–¹æ³•:</strong><br>
                                                â€¢ <strong>å˜ä½“ç”Ÿæˆ:</strong> é¸æŠã—ãŸå•†å“ã‹ã‚‰1ã¤ã®æŠ•ç¨¿ã‚’ç”Ÿæˆ<br>
                                                â€¢ <strong>ä¸€æ‹¬ç”Ÿæˆ:</strong> å…¨å•†å“ã‹ã‚‰æŠ•ç¨¿ã‚’è‡ªå‹•ç”Ÿæˆã—ã€24æ™‚é–“å¾Œã‹ã‚‰é †æ¬¡äºˆç´„æŠ•ç¨¿ã¨ã—ã¦ç™»éŒ²
                                            </small>
                                        </div>
                                        <div class="generation-progress mt-3">
                                            <div class="progress">
                                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-muted">ç”Ÿæˆä¸­...</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="card mt-3" id="generation-result" style="display: none;">
                                    <div class="card-header">
                                        <h6 class="mb-0">
                                            <i class="bi bi-check-circle"></i>
                                            ç”Ÿæˆçµæœ
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="generated-content"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="alert-container"></div>

    <!-- ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="imageGalleryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-images"></i>
                        å•†å“ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="gallery-content">
                        <div class="text-center py-4">
                            <i class="bi bi-arrow-clockwise"></i>
                            èª­ã¿è¾¼ã¿ä¸­...
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Sheetsè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="configModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-google"></i>
                        Google Sheets è¨­å®š
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-key"></i>
                                        èªè¨¼è¨­å®š
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Google Service Accountèªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«</label>
                                        <input type="file" class="form-control" id="credentials-file" accept=".json">
                                        <div class="form-text">
                                            Google Cloud Consoleã§Service Accountã‚­ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-primary" onclick="uploadCredentials()">
                                        <i class="bi bi-upload"></i>
                                        èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-table"></i>
                                        ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆè¨­å®š
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID</label>
                                        <input type="text" class="form-control" id="spreadsheet-id" 
                                               placeholder="ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®URLã‹ã‚‰IDã‚’å–å¾—">
                                        <div class="form-text">
                                            ä¾‹: https://docs.google.com/spreadsheets/d/<strong>SPREADSHEET_ID</strong>/edit
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-success" onclick="saveConfig()">
                                        <i class="bi bi-check"></i>
                                        è¨­å®šã‚’ä¿å­˜
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-info-circle"></i>
                                        ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <ol>
                                        <li>Google Cloud Consoleã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ</li>
                                        <li>Google Sheets APIã‚’æœ‰åŠ¹åŒ–</li>
                                        <li>Service Accountã‚’ä½œæˆã—ã¦ã‚­ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</li>
                                        <li>ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’Service Accountã¨å…±æœ‰</li>
                                        <li>ä¸Šè¨˜ã®èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’è¨­å®š</li>
                                    </ol>
                                    <div class="alert alert-info">
                                        <strong>ãƒ’ãƒ³ãƒˆ:</strong> ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ã¯ã€ŒæŠ•ç¨¿ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ã¨ã€Œã‚¢ãƒ•ã‚£ãƒªç”¨ãƒ‡ãƒ¼ã‚¿ã€ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                    <button type="button" class="btn btn-primary" onclick="testConnection()">
                        <i class="bi bi-wifi"></i>
                        æ¥ç¶šãƒ†ã‚¹ãƒˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- LLMè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="llmConfigModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-robot"></i>
                        LLMè¨­å®š
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row" id="llm-providers-container">
                        <!-- ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®šã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                    <button type="button" class="btn btn-success" onclick="testAllConnections()">
                        <i class="bi bi-wifi"></i>
                        å…¨æ¥ç¶šãƒ†ã‚¹ãƒˆ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ãƒ¢ãƒ‡ãƒ«ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="modal fade" id="modelManagerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-gear"></i>
                        <span id="model-manager-provider"></span> ãƒ¢ãƒ‡ãƒ«ç®¡ç†
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-plus-circle"></i>
                                        ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«è¿½åŠ 
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">ãƒ¢ãƒ‡ãƒ«å</label>
                                        <input type="text" class="form-control" id="new-model-name" 
                                               placeholder="ä¾‹: gemma3:27b">
                                        <div class="form-text">
                                            Ollamaã®ãƒ¢ãƒ‡ãƒ«åã‚„ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«åã‚’å…¥åŠ›
                                        </div>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-primary" onclick="addCustomModel()">
                                            <i class="bi bi-plus"></i>
                                            è¿½åŠ 
                                        </button>
                                        <button type="button" class="btn btn-outline-success" 
                                                onclick="loadOllamaModels()" 
                                                id="load-ollama-models-btn" 
                                                style="display: none;">
                                            <i class="bi bi-download"></i>
                                            Ollamaãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-list"></i>
                                        ãƒ¢ãƒ‡ãƒ«ä¸€è¦§
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="models-list">
                                        <div class="text-center py-3">
                                            <i class="bi bi-arrow-clockwise"></i>
                                            èª­ã¿è¾¼ã¿ä¸­...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-3" id="ollama-installed-models" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-hdd"></i>
                                        Ollamaã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div id="installed-models-list">
                                        <!-- ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let isConnected = false;
        let affiliateProducts = [];
        let currentSheetName = 'ã‚¢ãƒ•ã‚£ãƒªç”¨ãƒ‡ãƒ¼ã‚¿';
        let customSheets = ['ã‚¢ãƒ•ã‚£ãƒªç”¨ãƒ‡ãƒ¼ã‚¿', 'å•†å“ãƒã‚¹ã‚¿ãƒ¼', 'æ–°å•†å“']; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚·ãƒ¼ãƒˆ

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            checkConnection();
            loadScheduledPosts();
            loadLLMProviders();
            loadCustomSheets();
        });

        // è¨­å®šã‚’èª­ã¿è¾¼ã¿
        async function loadConfig() {
            try {
                const response = await fetch('/api/sheets/config');
                const config = await response.json();
                
                console.log('èª­ã¿è¾¼ã¾ã‚ŒãŸè¨­å®š:', config);
                
                // è¨­å®šãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
                document.getElementById('spreadsheet-id').value = config.spreadsheet_id || '';
                
                // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆæƒ…å ±ã®è¡¨ç¤ºæ›´æ–°
                const infoEl = document.getElementById('spreadsheet-info');
                if (config.spreadsheet_id) {
                    infoEl.textContent = `ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID: ${config.spreadsheet_id.substring(0, 20)}...`;
                    // è¨­å®šãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    if (config.saved_config && config.saved_config.spreadsheet_id) {
                        showAlert('success', 'ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 3000);
                    }
                } else {
                    infoEl.textContent = 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“';
                }
                
                // èªè¨¼çŠ¶æ…‹ã®è¡¨ç¤ºæ›´æ–°
                if (config.credentials_configured) {
                    showAlert('info', 'Google Sheets APIèªè¨¼æ¸ˆã¿', 2000);
                }
                
            } catch (error) {
                console.error('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('warning', 'è¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        function showConfigModal() {
            const modal = new bootstrap.Modal(document.getElementById('configModal'));
            modal.show();
        }

        // èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        async function uploadCredentials() {
            const fileInput = document.getElementById('credentials-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('warning', 'èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/sheets/upload-credentials', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const result = await response.json();
                showAlert('success', result.message);
                
                // æ¥ç¶šçŠ¶æ³ã‚’å†ç¢ºèª
                checkConnection();
            } catch (error) {
                console.error('èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', `ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // è¨­å®šã‚’ä¿å­˜
        async function saveConfig() {
            const spreadsheetId = document.getElementById('spreadsheet-id').value.trim();
            
            if (!spreadsheetId) {
                showAlert('warning', 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                const response = await fetch('/api/sheets/configure', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        spreadsheet_id: spreadsheetId
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const result = await response.json();
                showAlert('success', result.message);
                
                // è¨­å®šã‚’å†èª­ã¿è¾¼ã¿
                loadConfig();
                checkConnection();
                
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modal = bootstrap.Modal.getInstance(document.getElementById('configModal'));
                modal.hide();
            } catch (error) {
                console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', `è¨­å®šã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // æ¥ç¶šç¢ºèª
        async function checkConnection() {
            try {
                const response = await fetch('/api/sheets/test-connection');
                const data = await response.json();
                
                console.log('æ¥ç¶šãƒ†ã‚¹ãƒˆçµæœ:', data); // ãƒ‡ãƒãƒƒã‚°ç”¨
                
                const statusEl = document.getElementById('connection-status');
                const indicatorEl = document.getElementById('status-indicator');
                
                if (data.connected) {
                    statusEl.textContent = 'Google Sheets APIã«æ¥ç¶šæ¸ˆã¿';
                    statusEl.className = 'mb-0 status-connected';
                    indicatorEl.className = 'bi bi-circle-fill status-connected';
                    isConnected = true;
                } else {
                    statusEl.textContent = data.message || 'Google Sheets APIã«æ¥ç¶šã§ãã¾ã›ã‚“';
                    statusEl.className = 'mb-0 status-disconnected';
                    indicatorEl.className = 'bi bi-circle-fill status-disconnected';
                    isConnected = false;
                }
            } catch (error) {
                console.error('æ¥ç¶šç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
                const statusEl = document.getElementById('connection-status');
                const indicatorEl = document.getElementById('status-indicator');
                statusEl.textContent = 'ã‚¨ãƒ©ãƒ¼: æ¥ç¶šç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ';
                statusEl.className = 'mb-0 status-disconnected';
                indicatorEl.className = 'bi bi-circle-fill status-disconnected';
                isConnected = false;
                showAlert('danger', 'æ¥ç¶šç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // äºˆç´„æŠ•ç¨¿ä¸€è¦§ã®èª­ã¿è¾¼ã¿
        async function loadScheduledPosts() {
            try {
                console.log('äºˆç´„æŠ•ç¨¿ã‚’èª­ã¿è¾¼ã¿ä¸­...'); // ãƒ‡ãƒãƒƒã‚°ç”¨
                const response = await fetch('/api/sheets/scheduled-posts');
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('äºˆç´„æŠ•ç¨¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ (ã‚µãƒ¼ãƒãƒ¼):', errorData);
                    throw new Error(errorData.detail || 'Failed to load scheduled posts');
                }
                
                const data = await response.json();
                console.log('äºˆç´„æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿:', data); // ãƒ‡ãƒãƒƒã‚°ç”¨
                renderScheduledPosts(data.posts || []);
            } catch (error) {
                console.error('äºˆç´„æŠ•ç¨¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('scheduled-posts-table').innerHTML = 
                    `<div class="alert alert-warning">äºˆç´„æŠ•ç¨¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</div>`;
            }
        }

        // äºˆç´„æŠ•ç¨¿ãƒ†ãƒ¼ãƒ–ãƒ«ã®æç”»
        function renderScheduledPosts(posts) {
            const container = document.getElementById('scheduled-posts-table');
            
            if (!posts || posts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-calendar-x" style="font-size: 3rem; color: #6c757d;"></i>
                        <p class="mt-2 text-muted">äºˆç´„æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
                    </div>
                `;
                return;
            }

            const tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>æŠ•ç¨¿å†…å®¹</th>
                                <th>æŠ•ç¨¿æ—¥æ™‚</th>
                                <th>ãƒœãƒƒãƒˆ</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${posts.map(post => `
                                <tr>
                                    <td>
                                        <div style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                                            ${post.content}
                                        </div>
                                    </td>
                                    <td>${new Date(post.scheduled_time).toLocaleString('ja-JP')}</td>
                                    <td>${post.bot_name || 'Unknown'}</td>
                                    <td>
                                        <span class="badge bg-${getStatusColor(post.status)}">${getStatusText(post.status)}</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="editScheduledPost('${post.id}')">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteScheduledPost('${post.id}')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHtml;
        }

        // ã‚·ãƒ¼ãƒˆé¸æŠ
        function selectSheet(sheetName) {
            currentSheetName = sheetName;
            document.getElementById('sheet-name-input').value = sheetName;
            document.getElementById('current-sheet-name').textContent = `ã‚·ãƒ¼ãƒˆ: ${sheetName}`;
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¿ãƒ–ã®æ›´æ–°
            document.querySelectorAll('.sheet-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // å•†å“ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
            loadProductsFromSheet();
        }

        // ã‚·ãƒ¼ãƒˆã‹ã‚‰å•†å“ã‚’èª­ã¿è¾¼ã¿
        async function loadProductsFromSheet() {
            if (!isConnected) {
                showAlert('warning', 'Google Sheets APIã«æ¥ç¶šã—ã¦ãã ã•ã„');
                return;
            }

            const sheetName = document.getElementById('sheet-name-input').value.trim();
            if (!sheetName) {
                showAlert('warning', 'ã‚·ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            try {
                console.log(`ã‚·ãƒ¼ãƒˆ "${sheetName}" ã‹ã‚‰å•†å“ã‚’èª­ã¿è¾¼ã¿ä¸­...`);
                
                // ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã‚·ãƒ¼ãƒˆåã‚’æŒ‡å®šã—ã¦å–å¾—
                const response = await fetch(`/api/llm/affiliate-products?sheet_name=${encodeURIComponent(sheetName)}`);
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('å•†å“èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ (ã‚µãƒ¼ãƒãƒ¼):', errorData);
                    throw new Error(errorData.detail || 'Failed to load affiliate products');
                }
                
                const data = await response.json();
                console.log(`ã‚·ãƒ¼ãƒˆ "${sheetName}" ã®å•†å“ãƒ‡ãƒ¼ã‚¿:`, data);
                
                currentSheetName = sheetName;
                affiliateProducts = data.products || [];
                renderAffiliateProducts(affiliateProducts);
                updateProductSelect();
                
                showAlert('success', `ã‚·ãƒ¼ãƒˆ "${sheetName}" ã‹ã‚‰ ${affiliateProducts.length} ä»¶ã®å•†å“ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            } catch (error) {
                console.error('å•†å“èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', `å•†å“ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        // å•†å“ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆç¾åœ¨ã®ã‚·ãƒ¼ãƒˆã§å†èª­ã¿è¾¼ã¿ï¼‰
        function refreshProducts() {
            loadProductsFromSheet();
        }

        // ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ 
        function addCustomSheet() {
            const sheetName = prompt('è¿½åŠ ã™ã‚‹ã‚·ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
            if (sheetName && !customSheets.includes(sheetName)) {
                customSheets.push(sheetName);
                updateSheetTabs();
                saveCustomSheets();
                showAlert('success', `ã‚·ãƒ¼ãƒˆ "${sheetName}" ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
            } else if (customSheets.includes(sheetName)) {
                showAlert('warning', 'ãã®ã‚·ãƒ¼ãƒˆåã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
            }
        }

        // ã‚·ãƒ¼ãƒˆã‚¿ãƒ–ã‚’æ›´æ–°
        function updateSheetTabs() {
            const tabsContainer = document.getElementById('sheet-tabs');
            tabsContainer.innerHTML = customSheets.map(sheet => 
                `<span class="sheet-tab ${sheet === currentSheetName ? 'active' : ''}" 
                       onclick="selectSheet('${sheet}')">${sheet}</span>`
            ).join('');
        }

        // ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒ¼ãƒˆã‚’ä¿å­˜ï¼ˆlocalStorageä½¿ç”¨ï¼‰
        function saveCustomSheets() {
            localStorage.setItem('customSheets', JSON.stringify(customSheets));
        }

        // ã‚«ã‚¹ã‚¿ãƒ ã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
        function loadCustomSheets() {
            const saved = localStorage.getItem('customSheets');
            if (saved) {
                customSheets = JSON.parse(saved);
                updateSheetTabs();
            }
        }

        // å•†å“é¸æŠï¼ˆAIç”Ÿæˆç”¨ï¼‰
        function selectProductForGeneration(productId) {
            const selectEl = document.getElementById('selected-product');
            selectEl.value = productId;
            
            // AIç”Ÿæˆã‚¿ãƒ–ã«ç§»å‹•
            const generationTab = document.querySelector('#generation-tab');
            generationTab.click();
            
            showAlert('info', 'å•†å“ã‚’é¸æŠã—ã¾ã—ãŸã€‚AIæŠ•ç¨¿ç”Ÿæˆã‚¿ãƒ–ã§ç”Ÿæˆè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        }

        // ã‚¢ãƒ•ã‚£ãƒªå•†å“ã®èª­ã¿è¾¼ã¿ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
        async function loadAffiliateProducts() {
            loadProductsFromSheet();
        }

        // ã‚¢ãƒ•ã‚£ãƒªå•†å“ã®æç”»ï¼ˆæ–°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¯¾å¿œï¼‰
        function renderAffiliateProducts(products) {
            const container = document.getElementById('affiliate-products');
            const countEl = document.getElementById('product-count');
            
            if (!products || products.length === 0) {
                countEl.textContent = '0';
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-cart-x" style="font-size: 3rem; color: #6c757d;"></i>
                        <p class="mt-2 text-muted">é¸æŠã—ãŸã‚·ãƒ¼ãƒˆã«å•†å“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>
                        <div class="alert alert-info">
                            <small>
                                <strong>æœŸå¾…ã•ã‚Œã‚‹ãƒ˜ãƒƒãƒ€ãƒ¼:</strong><br>
                                Content ID, Product ID, Title, URL, Affiliate URL, Date, Description, Created At, Sample Image URL 1-20
                            </small>
                        </div>
                        <button class="btn btn-outline-primary" onclick="loadProductsFromSheet()">
                            <i class="bi bi-arrow-clockwise"></i>
                            å†èª­ã¿è¾¼ã¿
                        </button>
                    </div>
                `;
                return;
            }

            countEl.textContent = products.length;

            const productsHtml = products.map(product => {
                // ç”»åƒè¡¨ç¤ºã®å‡¦ç†
                const firstImage = product.sample_images && product.sample_images.length > 0 ? product.sample_images[0] : null;
                const imageHtml = firstImage ? 
                    `<img src="${firstImage}" class="product-image" alt="${product.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                     <div class="product-image-placeholder" style="display:none;">
                         <i class="bi bi-image" style="font-size: 2rem;"></i>
                     </div>` :
                    `<div class="product-image-placeholder">
                         <i class="bi bi-image" style="font-size: 2rem;"></i>
                     </div>`;

                // æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                const formattedDate = product.date ? new Date(product.date).toLocaleDateString('ja-JP') : '';
                
                return `
                    <div class="card product-card h-100" onclick="selectProductForGeneration('${product.id}')">
                        <div class="position-relative">
                            ${imageHtml}
                            <div class="product-badges position-absolute" style="top: 0.5rem; left: 0.5rem;">
                                ${product.sample_images_count > 0 ? 
                                    `<span class="badge bg-primary">${product.sample_images_count} ç”»åƒ</span>` : 
                                    '<span class="badge bg-secondary">ç”»åƒãªã—</span>'
                                }
                                ${product.affiliate_url ? '<span class="badge bg-success">ã‚¢ãƒ•ã‚£ãƒª</span>' : ''}
                            </div>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title">${product.title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</h6>
                            <div class="product-meta mb-2">
                                <div class="d-flex justify-content-between">
                                    <span><i class="bi bi-hash"></i> ${product.product_id || product.content_id}</span>
                                    ${formattedDate ? `<span><i class="bi bi-calendar"></i> ${formattedDate}</span>` : ''}
                                </div>
                            </div>
                            <p class="card-text product-description small">${product.description || ''}</p>
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-grid gap-1">
                                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); generateFromProduct('${product.id}')">
                                    <i class="bi bi-magic"></i>
                                    æŠ•ç¨¿ç”Ÿæˆ
                                </button>
                                <div class="btn-group btn-group-sm" role="group">
                                    ${product.url ? 
                                        `<a href="${product.url}" target="_blank" class="btn btn-outline-secondary" onclick="event.stopPropagation()">
                                            <i class="bi bi-box-arrow-up-right"></i> è©³ç´°
                                        </a>` : ''
                                    }
                                    ${product.affiliate_url ? 
                                        `<a href="${product.affiliate_url}" target="_blank" class="btn btn-outline-success" onclick="event.stopPropagation()">
                                            <i class="bi bi-link-45deg"></i> ã‚¢ãƒ•ã‚£ãƒª
                                        </a>` : ''
                                    }
                                    ${product.sample_images_count > 1 ? 
                                        `<button class="btn btn-outline-info" onclick="event.stopPropagation(); showImageGallery('${product.id}')">
                                            <i class="bi bi-images"></i> ã‚®ãƒ£ãƒ©ãƒªãƒ¼
                                        </button>` : ''
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="product-grid">${productsHtml}</div>`;
        }

        // LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®èª­ã¿è¾¼ã¿
        async function loadLLMProviders() {
            try {
                const response = await fetch('/api/llm/providers');
                if (!response.ok) throw new Error('Failed to load providers');
                
                const data = await response.json();
                const providerSelect = document.getElementById('provider');
                providerSelect.innerHTML = '';
                
                data.providers.forEach(provider => {
                    const option = document.createElement('option');
                    option.value = provider.name;
                    option.textContent = `${provider.display_name} ${provider.available ? '' : '(åˆ©ç”¨ä¸å¯)'}`;
                    option.disabled = !provider.available;
                    providerSelect.appendChild(option);
                });
            } catch (error) {
                console.error('ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        // å•†å“é¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®æ›´æ–°
        function updateProductSelect() {
            const select = document.getElementById('selected-product');
            select.innerHTML = '<option value="">å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
            
            affiliateProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = product.name || 'Unnamed Product';
                select.appendChild(option);
            });
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ã®åŒæœŸ
        async function syncFromSheets() {
            if (!isConnected) {
                showAlert('warning', 'Google Sheets APIã«æ¥ç¶šã—ã¦ãã ã•ã„');
                return;
            }

            try {
                showAlert('info', 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰åŒæœŸä¸­...', 3000);
                const response = await fetch('/api/sheets/sync-from-sheets', {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('Sync failed');
                
                const data = await response.json();
                showAlert('success', `${data.synced_count}ä»¶ã®æŠ•ç¨¿ã‚’åŒæœŸã—ã¾ã—ãŸ`);
                loadScheduledPosts();
            } catch (error) {
                console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', 'åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸ã®åŒæœŸ
        async function syncToSheets() {
            if (!isConnected) {
                showAlert('warning', 'Google Sheets APIã«æ¥ç¶šã—ã¦ãã ã•ã„');
                return;
            }

            try {
                showAlert('info', 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã¸åŒæœŸä¸­...', 3000);
                const response = await fetch('/api/sheets/sync-to-sheets', {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('Sync failed');
                
                const data = await response.json();
                showAlert('success', `${data.synced_count}ä»¶ã‚’ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«åŒæœŸã—ã¾ã—ãŸ`);
            } catch (error) {
                console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', 'åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // å˜ä½“æŠ•ç¨¿ç”Ÿæˆ
        async function generateSinglePost() {
            const productId = document.getElementById('selected-product').value;
            if (!productId) {
                showAlert('warning', 'å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }

            const settings = getGenerationSettings();
            console.log('=== AIæŠ•ç¨¿ç”Ÿæˆãƒ‡ãƒãƒƒã‚°æƒ…å ± ===');
            console.log('é¸æŠã•ã‚ŒãŸå•†å“ID:', productId);
            console.log('ç”Ÿæˆè¨­å®š:', settings);
            console.log('ã‚¢ãƒ•ã‚£ãƒªå•†å“ãƒ‡ãƒ¼ã‚¿æ•°:', affiliateProducts.length);
            console.log('é¸æŠã•ã‚ŒãŸå•†å“ãƒ‡ãƒ¼ã‚¿:', affiliateProducts.find(p => p.id === productId));
            console.log('Google Sheetsæ¥ç¶šçŠ¶æ…‹:', isConnected);
            
            // äº‹å‰ãƒã‚§ãƒƒã‚¯
            if (!isConnected) {
                showAlert('warning', 'Google Sheets APIã«æ¥ç¶šã—ã¦ãã ã•ã„');
                return;
            }
            
            if (affiliateProducts.length === 0) {
                showAlert('warning', 'å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
                return;
            }
            
            if (!settings.provider) {
                showAlert('warning', 'LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            // LLMè¨­å®šã®è©³ç´°ãƒã‚§ãƒƒã‚¯
            try {
                const llmConfigResponse = await fetch('/api/llm/config');
                const llmConfig = await llmConfigResponse.json();
                console.log('LLMè¨­å®šçŠ¶æ…‹:', llmConfig);
                
                const selectedProvider = llmConfig.available_providers.find(p => p.name === settings.provider);
                console.log('é¸æŠã•ã‚ŒãŸãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼æƒ…å ±:', selectedProvider);
                
                if (!selectedProvider || !selectedProvider.available) {
                    showAlert('warning', `${settings.provider} ã®è¨­å®šãŒä¸å®Œå…¨ã§ã™ã€‚LLMè¨­å®šã§APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚`);
                    return;
                }
            } catch (configError) {
                console.error('LLMè¨­å®šãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', configError);
                showAlert('warning', 'LLMè¨­å®šã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸã€‚LLMè¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            try {
                showGenerationProgress(true);
                showAlert('info', 'AIæŠ•ç¨¿ã‚’ç”Ÿæˆä¸­...', 3000);
                
                // ã‚¹ãƒ†ãƒƒãƒ—1: APIå‘¼ã³å‡ºã—é–‹å§‹
                console.log('ğŸš€ APIå‘¼ã³å‡ºã—é–‹å§‹:', `/api/llm/generate-from-affiliate-data/${productId}`);
                console.log('ğŸ“¤ é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', JSON.stringify(settings, null, 2));
                
                const response = await fetch(`/api/llm/generate-from-affiliate-data/${productId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });
                
                // ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèª
                console.log('ğŸ“¡ API ãƒ¬ã‚¹ãƒãƒ³ã‚¹çŠ¶æ…‹:', response.status);
                console.log('ğŸ“‹ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    console.error('âŒ APIã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ');
                    const errorData = await response.json();
                    console.error('ğŸ“„ ã‚¨ãƒ©ãƒ¼è©³ç´°:', errorData);
                    throw new Error(errorData.detail || `HTTP ${response.status}: Generation failed`);
                }
                
                // ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‡ãƒ¼ã‚¿è§£æ
                const data = await response.json();
                console.log('âœ… APIæˆåŠŸ - ç”Ÿæˆçµæœ:', data);
                console.log('ğŸ“Š ç”Ÿæˆãƒ‡ãƒ¼ã‚¿æ§‹é€ :', {
                    success: data.success,
                    hasContent: !!data.content,
                    contentLength: data.content ? data.content.length : 0,
                    hasSourceData: !!data.source_data,
                    provider: data.provider,
                    model: data.model
                });
                
                if (data.success) {
                    showGenerationResult(data.content, data.source_data);
                    showAlert('success', 'æŠ•ç¨¿ã‚’ç”Ÿæˆã—ã¾ã—ãŸ');
                } else {
                    throw new Error(data.error || 'Generation failed');
                }
            } catch (error) {
                console.error('ç”Ÿæˆã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
                console.error('ã‚¨ãƒ©ãƒ¼ã®å‹:', typeof error);
                console.error('ã‚¨ãƒ©ãƒ¼ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£:', Object.keys(error));
                
                let errorMessage = 'æŠ•ç¨¿ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
                let errorDetail = '';
                
                // ã‚¨ãƒ©ãƒ¼ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®è©³ç´°ãªè§£æ
                if (error && typeof error === 'object') {
                    if (error.message) {
                        errorDetail = error.message;
                    } else if (error.detail) {
                        errorDetail = error.detail;
                    } else if (error.error) {
                        errorDetail = error.error;
                    } else {
                        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ–‡å­—åˆ—åŒ–
                        try {
                            errorDetail = JSON.stringify(error, null, 2);
                        } catch (e) {
                            errorDetail = String(error);
                        }
                    }
                } else {
                    errorDetail = String(error);
                }
                
                console.log('è§£æã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼è©³ç´°:', errorDetail);
                
                // ã‚¨ãƒ©ãƒ¼ã®ç¨®é¡ã«å¿œã˜ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (errorDetail.includes('å•†å“ID') || errorDetail.includes('è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')) {
                    errorMessage += '\nå•†å“ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å•†å“ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
                } else if (errorDetail.includes('èªè¨¼')) {
                    errorMessage += '\nGoogle Sheets APIèªè¨¼ãŒå¿…è¦ã§ã™ã€‚';
                } else if (errorDetail.includes('API key') || errorDetail.includes('è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“')) {
                    errorMessage += '\nLLM APIè¨­å®šãŒä¸å®Œå…¨ã§ã™ã€‚LLMè¨­å®šã§APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } else if (errorDetail.includes('Connection') || errorDetail.includes('æ¥ç¶š')) {
                    errorMessage += '\nLLMã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚';
                } else {
                    errorMessage += `\nè©³ç´°: ${errorDetail}`;
                }
                
                showAlert('danger', errorMessage);
            } finally {
                showGenerationProgress(false);
            }
        }

        // ä¸€æ‹¬æŠ•ç¨¿ç”Ÿæˆ
        async function generateBatchPosts() {
            if (affiliateProducts.length === 0) {
                showAlert('warning', 'å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
                return;
            }

            const settings = getGenerationSettings();
            const productIds = affiliateProducts.map(p => p.id);
            
            try {
                showGenerationProgress(true);
                const response = await fetch('/api/llm/generate-batch-posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        product_ids: productIds,
                        generation_settings: settings
                    })
                });
                
                if (!response.ok) throw new Error('Batch generation failed');
                
                const data = await response.json();
                showAlert('success', data.message);
            } catch (error) {
                console.error('ä¸€æ‹¬ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', 'ä¸€æ‹¬ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            } finally {
                showGenerationProgress(false);
            }
        }

        // ç”Ÿæˆè¨­å®šã®å–å¾—
        function getGenerationSettings() {
            return {
                provider: document.getElementById('provider').value,
                post_type: document.getElementById('post-type').value,
                target_audience: document.getElementById('target-audience').value,
                tone: document.getElementById('tone').value,
                include_hashtags: document.getElementById('include-hashtags').checked,
                max_length: 280
            };
        }

        // ç”Ÿæˆé€²è¡ŒçŠ¶æ³ã®è¡¨ç¤º
        function showGenerationProgress(show) {
            const progressEl = document.querySelector('.generation-progress');
            progressEl.style.display = show ? 'block' : 'none';
        }

        // ç”Ÿæˆçµæœã®è¡¨ç¤º
        function showGenerationResult(content, sourceData) {
            const resultEl = document.getElementById('generation-result');
            const contentEl = document.getElementById('generated-content');
            
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦å®‰å…¨ã«HTMLã«æŒ¿å…¥
            const escapedContent = content.replace(/"/g, '&quot;').replace(/'/g, '&#x27;');
            
            contentEl.innerHTML = `
                <div class="mb-3">
                    <label class="form-label">ç”Ÿæˆã•ã‚ŒãŸæŠ•ç¨¿å†…å®¹:</label>
                    <textarea class="form-control" rows="4" readonly id="generated-textarea"></textarea>
                </div>
                ${sourceData ? `
                <div class="mb-3">
                    <small class="text-muted">
                        å•†å“: ${sourceData.product_name} (ID: ${sourceData.product_id})
                    </small>
                </div>
                ` : ''}
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="useGeneratedContent(\`${escapedContent}\`)">
                        <i class="bi bi-check"></i>
                        ã“ã®å†…å®¹ã‚’ä½¿ç”¨
                    </button>
                    <button class="btn btn-outline-secondary" onclick="copyToClipboard(\`${escapedContent}\`)">
                        <i class="bi bi-copy"></i>
                        ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                    </button>
                </div>
            `;
            
            // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«å†…å®¹ã‚’ã‚»ãƒƒãƒˆ
            const textarea = document.getElementById('generated-textarea');
            if (textarea) {
                textarea.value = content;
            }
            
            resultEl.style.display = 'block';
        }

        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
        function copyToClipboard(content) {
            const decodedContent = content.replace(/&#x27;/g, "'").replace(/&quot;/g, '"');
            navigator.clipboard.writeText(decodedContent).then(() => {
                showAlert('success', 'ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(() => {
                showAlert('warning', 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }

        // ç”Ÿæˆã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½¿ç”¨
        function useGeneratedContent(content) {
            // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã•ã‚ŒãŸå†…å®¹ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
            const decodedContent = content.replace(/&#x27;/g, "'").replace(/&quot;/g, '"');
            
            // æŠ•ç¨¿ç®¡ç†ã‚¿ãƒ–ã«ç§»å‹•ã—ã¦å†…å®¹ã‚’ã‚»ãƒƒãƒˆ
            const scheduleTab = document.querySelector('#schedule-tab');
            if (scheduleTab) {
                scheduleTab.click();
                
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å†…å®¹ã‚’ã‚»ãƒƒãƒˆ
                setTimeout(() => {
                    const contentField = document.getElementById('post-content');
                    if (contentField) {
                        contentField.value = decodedContent;
                        showAlert('success', 'ç”Ÿæˆã•ã‚ŒãŸå†…å®¹ã‚’æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã«ã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
                    } else {
                        // ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                        navigator.clipboard.writeText(decodedContent).then(() => {
                            showAlert('success', 'ç”Ÿæˆã•ã‚ŒãŸå†…å®¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                        }).catch(() => {
                            showAlert('info', 'ç”Ÿæˆã•ã‚ŒãŸå†…å®¹:\n' + decodedContent);
                        });
                    }
                }, 100);
            } else {
                // æŠ•ç¨¿ç®¡ç†ã‚¿ãƒ–ãŒãªã„å ´åˆã¯ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼
                navigator.clipboard.writeText(decodedContent).then(() => {
                    showAlert('success', 'ç”Ÿæˆã•ã‚ŒãŸå†…å®¹ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                }).catch(() => {
                    showAlert('info', 'ç”Ÿæˆã•ã‚ŒãŸå†…å®¹:\n' + decodedContent);
                });
            }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function getStatusColor(status) {
            const colors = {
                'pending': 'warning',
                'processing': 'info',
                'posted': 'success',
                'failed': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function getStatusText(status) {
            const texts = {
                'pending': 'å¾…æ©Ÿä¸­',
                'processing': 'å‡¦ç†ä¸­',
                'posted': 'æŠ•ç¨¿æ¸ˆã¿',
                'failed': 'å¤±æ•—'
            };
            return texts[status] || status;
        }

        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        function showAlert(type, message, duration = 5000) {
            const alertContainer = document.getElementById('alert-container');
            const alertId = 'alert-' + Date.now();
            
            // è¤‡æ•°è¡Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ”¹è¡Œã§å‡¦ç†
            const formattedMessage = message.replace(/\n/g, '<br>');
            
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" id="${alertId}" style="white-space: pre-line; line-height: 1.4;">
                    <div style="display: flex; align-items: flex-start; gap: 8px;">
                        <div style="flex: 1;">
                            ${formattedMessage}
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" style="margin-left: auto; flex-shrink: 0;"></button>
                    </div>
                </div>
            `;
            
            // æ—¢å­˜ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
            alertContainer.innerHTML = '';
            alertContainer.innerHTML = alertHtml;
            
            if (duration > 0) {
                setTimeout(() => {
                    const alert = document.getElementById(alertId);
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, duration);
            }
        }

        // ã‚µãƒ³ãƒ—ãƒ«ã‚·ãƒ¼ãƒˆä½œæˆ
        async function createSampleSheets() {
            if (!isConnected) {
                showAlert('warning', 'Google Sheets APIã«æ¥ç¶šã—ã¦ãã ã•ã„');
                return;
            }

            try {
                showAlert('info', 'ã‚µãƒ³ãƒ—ãƒ«ã‚·ãƒ¼ãƒˆã‚’ä½œæˆä¸­...', 3000);
                const response = await fetch('/api/sheets/create-sample-sheet', {
                    method: 'POST'
                });
                
                if (!response.ok) throw new Error('Sample creation failed');
                
                const data = await response.json();
                showAlert('success', 'ã‚µãƒ³ãƒ—ãƒ«ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸï¼å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„ã€‚');
            } catch (error) {
                console.error('ã‚µãƒ³ãƒ—ãƒ«ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', 'ã‚µãƒ³ãƒ—ãƒ«ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ã‚’è¡¨ç¤º
        function showImageGallery(productId) {
            const product = affiliateProducts.find(p => p.id === productId);
            if (!product || !product.sample_images || product.sample_images.length === 0) {
                showAlert('warning', 'è¡¨ç¤ºã§ãã‚‹ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }

            const galleryContent = document.getElementById('gallery-content');
            const imagesHtml = product.sample_images.map((imageUrl, index) => `
                <div class="col-md-4 mb-3">
                    <div class="card">
                        <img src="${imageUrl}" class="card-img-top" alt="å•†å“ç”»åƒ ${index + 1}" 
                             style="height: 200px; object-fit: cover; cursor: pointer;"
                             onclick="openImageInNewTab('${imageUrl}')"
                             onerror="this.parentElement.innerHTML='<div class=\\'text-center p-3 text-muted\\'>ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“</div>'">
                        <div class="card-body p-2">
                            <small class="text-muted">ç”»åƒ ${index + 1}</small>
                            <div class="btn-group btn-group-sm w-100 mt-1">
                                <button class="btn btn-outline-primary" onclick="copyImageUrl('${imageUrl}')">
                                    <i class="bi bi-copy"></i> URL
                                </button>
                                <a href="${imageUrl}" target="_blank" class="btn btn-outline-secondary">
                                    <i class="bi bi-box-arrow-up-right"></i> é–‹ã
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            galleryContent.innerHTML = `
                <div class="mb-3">
                    <h6>${product.title}</h6>
                    <p class="text-muted small">${product.description || ''}</p>
                </div>
                <div class="row">
                    ${imagesHtml}
                </div>
            `;

            const modal = new bootstrap.Modal(document.getElementById('imageGalleryModal'));
            modal.show();
        }

        // ç”»åƒURLã‚’ã‚³ãƒ”ãƒ¼
        function copyImageUrl(url) {
            navigator.clipboard.writeText(url).then(() => {
                showAlert('success', 'URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }).catch(() => {
                showAlert('warning', 'URLã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
            });
        }

        // ç”»åƒã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
        function openImageInNewTab(url) {
            window.open(url, '_blank');
        }

        // æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ï¼‰
        async function testConnection() {
            try {
                showAlert('info', 'æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...', 2000);
                
                const response = await fetch('/api/sheets/test-connection');
                const data = await response.json();
                
                console.log('æ¥ç¶šãƒ†ã‚¹ãƒˆçµæœï¼ˆè©³ç´°ï¼‰:', data);
                
                if (data.connected) {
                    showAlert('success', 'æ¥ç¶šãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼');
                } else {
                    showAlert('warning', `æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—: ${data.message}`);
                }
            } catch (error) {
                console.error('æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', 'æ¥ç¶šãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ™‚ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        document.getElementById('affiliate-tab').addEventListener('shown.bs.tab', function() {
            if (affiliateProducts.length === 0) {
                loadAffiliateProducts();
            }
        });

        // === LLMè¨­å®šé–¢é€£ã®é–¢æ•° ===
        
        // LLMè¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        async function openLLMConfigModal() {
            await loadLLMConfig();
            const modal = new bootstrap.Modal(document.getElementById('llmConfigModal'));
            modal.show();
        }

        // LLMè¨­å®šã‚’èª­ã¿è¾¼ã¿
        async function loadLLMConfig() {
            try {
                const response = await fetch('/api/llm/config');
                const data = await response.json();
                
                const container = document.getElementById('llm-providers-container');
                container.innerHTML = '';
                
                data.available_providers.forEach(provider => {
                    const card = createProviderConfigCard(provider);
                    container.appendChild(card);
                });
                
            } catch (error) {
                console.error('LLMè¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', 'LLMè¨­å®šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®šã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
        function createProviderConfigCard(provider) {
            const col = document.createElement('div');
            col.className = 'col-md-6 mb-3';
            
            const availableIcon = provider.available ? 
                '<i class="bi bi-check-circle text-success"></i>' : 
                '<i class="bi bi-x-circle text-danger"></i>';
            
            const availableText = provider.available ? 'åˆ©ç”¨å¯èƒ½' : 'è¨­å®šãŒå¿…è¦';
            
            const models = provider.models.map(model => 
                `<option value="${model}">${model}</option>`
            ).join('');
            
            // Ollamaã®å ´åˆã¯APIã‚­ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            const isOllama = provider.name === 'ollama';
            const apiKeySection = isOllama ? '' : `
                <div class="mb-3">
                    <label class="form-label">API Key</label>
                    <div class="input-group">
                        <input type="password" class="form-control" 
                               id="${provider.name}-api-key" 
                               placeholder="${provider.config.api_key_configured ? 'è¨­å®šæ¸ˆã¿' : 'API Keyã‚’å…¥åŠ›'}">
                        <button class="btn btn-outline-secondary" type="button" 
                                onclick="togglePasswordVisibility('${provider.name}-api-key')">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
            `;
            
            const baseUrlPlaceholder = isOllama ? 
                'http://localhost:11434' : 
                'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨';
            
            const baseUrlHelp = isOllama ? 
                '<div class="form-text">Ollamaã‚µãƒ¼ãƒãƒ¼ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆé€šå¸¸ã¯ localhost:11434ï¼‰</div>' : 
                '';
            
            col.innerHTML = `
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="bi bi-robot"></i>
                            ${provider.display_name}
                            ${isOllama ? '<small class="text-muted ms-2">(ãƒ­ãƒ¼ã‚«ãƒ«)</small>' : ''}
                        </h6>
                        <span class="badge ${provider.available ? 'bg-success' : 'bg-warning'}">
                            ${availableIcon} ${availableText}
                        </span>
                    </div>
                    <div class="card-body">
                        ${apiKeySection}
                        
                        <div class="mb-3">
                            <label class="form-label">Base URL</label>
                            <input type="text" class="form-control" 
                                   id="${provider.name}-base-url" 
                                   value="${provider.config.base_url}"
                                   placeholder="${baseUrlPlaceholder}">
                            ${baseUrlHelp}
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">ãƒ¢ãƒ‡ãƒ«</label>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="${provider.name}-model">
                                    ${models}
                                </select>
                                <button type="button" class="btn btn-outline-info btn-sm" 
                                        onclick="showModelManager('${provider.name}')" 
                                        title="ãƒ¢ãƒ‡ãƒ«ç®¡ç†">
                                    <i class="bi bi-gear"></i>
                                </button>
                            </div>
                            ${isOllama ? '<div class="form-text">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã¯ã€Œãƒ¢ãƒ‡ãƒ«ç®¡ç†ã€ã‹ã‚‰è¿½åŠ ã§ãã¾ã™</div>' : ''}
                        </div>
                        
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary" 
                                    onclick="saveLLMConfig('${provider.name}')">
                                <i class="bi bi-check"></i>
                                è¨­å®šã‚’ä¿å­˜
                            </button>
                            <button type="button" class="btn btn-outline-success" 
                                    onclick="testLLMConnection('${provider.name}')">
                                <i class="bi bi-wifi"></i>
                                æ¥ç¶šãƒ†ã‚¹ãƒˆ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // ç¾åœ¨ã®è¨­å®šå€¤ã‚’ã‚»ãƒƒãƒˆ
            setTimeout(() => {
                const modelSelect = col.querySelector(`#${provider.name}-model`);
                if (provider.config.model && modelSelect) {
                    modelSelect.value = provider.config.model;
                }
            }, 0);
            
            return col;
        }

        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'bi bi-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'bi bi-eye';
            }
        }

        // LLMè¨­å®šã‚’ä¿å­˜
        async function saveLLMConfig(provider) {
            try {
                // Ollamaã®å ´åˆã¯APIã‚­ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹
                const apiKeyElement = document.getElementById(`${provider}-api-key`);
                const apiKey = apiKeyElement ? apiKeyElement.value : '';
                const baseUrl = document.getElementById(`${provider}-base-url`).value;
                const model = document.getElementById(`${provider}-model`).value;
                
                const config = {
                    provider: provider,
                    api_key: provider === 'ollama' ? '' : (apiKey || undefined),
                    base_url: baseUrl || undefined,
                    model: model || undefined
                };
                
                const response = await fetch('/api/llm/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'è¨­å®šä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const result = await response.json();
                showAlert('success', result.message);
                
                // è¨­å®šã‚’å†èª­ã¿è¾¼ã¿
                await loadLLMConfig();
                
            } catch (error) {
                console.error('LLMè¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', `è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // LLMæ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testLLMConnection(provider) {
            try {
                showAlert('info', `${provider} ã®æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...`, 2000);
                
                const response = await fetch(`/api/llm/test-connection/${provider}`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.connected) {
                    let message = `${provider.toUpperCase()} ã®æ¥ç¶šãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼`;
                    
                    // Ollamaã®å ´åˆã¯è©³ç´°æƒ…å ±ã‚’è¿½åŠ 
                    if (provider === 'ollama' && result.available_models !== undefined) {
                        message += `\nåˆ©ç”¨å¯èƒ½ãƒ¢ãƒ‡ãƒ«: ${result.available_models} å€‹`;
                        if (result.test_model) {
                            message += `\nãƒ†ã‚¹ãƒˆãƒ¢ãƒ‡ãƒ«: ${result.test_model}`;
                        }
                    }
                    
                    showAlert('success', message);
                } else {
                    let errorMsg = `${provider.toUpperCase()} ã®æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—`;
                    if (result.error) {
                        errorMsg += `\nè©³ç´°: ${result.error}`;
                    }
                    showAlert('warning', errorMsg);
                }
                
            } catch (error) {
                console.error('LLMæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', `${provider.toUpperCase()} ã®æ¥ç¶šãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`);
            }
        }

        // å…¨æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testAllConnections() {
            try {
                const response = await fetch('/api/llm/config');
                const data = await response.json();
                
                showAlert('info', 'å…¨ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®æ¥ç¶šãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™...', 3000);
                
                for (const provider of data.available_providers) {
                    if (provider.available) {
                        await testLLMConnection(provider.name);
                        await new Promise(resolve => setTimeout(resolve, 1000)); // 1ç§’å¾…æ©Ÿ
                    }
                }
                
                showAlert('success', 'å…¨æ¥ç¶šãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ');
                
            } catch (error) {
                console.error('å…¨æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', 'å…¨æ¥ç¶šãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // === ãƒ¢ãƒ‡ãƒ«ç®¡ç†é–¢é€£ã®é–¢æ•° ===
        let currentModelProvider = '';

        // ãƒ¢ãƒ‡ãƒ«ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        async function showModelManager(provider) {
            currentModelProvider = provider;
            document.getElementById('model-manager-provider').textContent = provider.toUpperCase();
            
            // Ollamaã®å ´åˆã¯Ollamaãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            const ollamaBtn = document.getElementById('load-ollama-models-btn');
            const ollamaSection = document.getElementById('ollama-installed-models');
            if (provider === 'ollama') {
                ollamaBtn.style.display = 'block';
                ollamaSection.style.display = 'block';
            } else {
                ollamaBtn.style.display = 'none';
                ollamaSection.style.display = 'none';
            }
            
            await loadProviderModels(provider);
            
            const modal = new bootstrap.Modal(document.getElementById('modelManagerModal'));
            modal.show();
        }

        // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        async function loadProviderModels(provider) {
            try {
                const response = await fetch(`/api/llm/models/${provider}`);
                const data = await response.json();
                
                const modelsList = document.getElementById('models-list');
                modelsList.innerHTML = '';
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«ã¨ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã‚’åˆ†ã‘ã¦è¡¨ç¤º
                const defaultModels = data.models.filter(model => 
                    !data.custom_models.includes(model)
                );
                const customModels = data.custom_models;
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«
                if (defaultModels.length > 0) {
                    const defaultSection = document.createElement('div');
                    defaultSection.innerHTML = `
                        <h6 class="text-muted mb-2">
                            <i class="bi bi-collection"></i>
                            ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ‡ãƒ«
                        </h6>
                    `;
                    
                    defaultModels.forEach(model => {
                        const modelItem = document.createElement('div');
                        modelItem.className = 'badge bg-light text-dark me-1 mb-1';
                        modelItem.innerHTML = `
                            <i class="bi bi-robot"></i>
                            ${model}
                        `;
                        defaultSection.appendChild(modelItem);
                    });
                    
                    modelsList.appendChild(defaultSection);
                }
                
                // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«
                if (customModels.length > 0) {
                    const customSection = document.createElement('div');
                    customSection.className = 'mt-3';
                    customSection.innerHTML = `
                        <h6 class="text-muted mb-2">
                            <i class="bi bi-gear"></i>
                            ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«
                        </h6>
                    `;
                    
                    customModels.forEach(model => {
                        const modelItem = document.createElement('div');
                        modelItem.className = 'd-flex justify-content-between align-items-center bg-light p-2 rounded mb-1';
                        modelItem.innerHTML = `
                            <span>
                                <i class="bi bi-robot text-primary"></i>
                                ${model}
                            </span>
                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                    onclick="removeCustomModel('${provider}', '${model}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        `;
                        customSection.appendChild(modelItem);
                    });
                    
                    modelsList.appendChild(customSection);
                } else if (defaultModels.length === 0) {
                    modelsList.innerHTML = '<div class="text-muted text-center py-3">ãƒ¢ãƒ‡ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                }
                
                // Ollamaã®å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚‚èª­ã¿è¾¼ã¿
                if (provider === 'ollama') {
                    await loadOllamaInstalledModels();
                }
                
            } catch (error) {
                console.error('ãƒ¢ãƒ‡ãƒ«ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', 'ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ 
        async function addCustomModel() {
            const modelName = document.getElementById('new-model-name').value.trim();
            
            if (!modelName) {
                showAlert('warning', 'ãƒ¢ãƒ‡ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                const response = await fetch('/api/llm/models/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        provider: currentModelProvider,
                        model_name: modelName
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ãƒ¢ãƒ‡ãƒ«è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const result = await response.json();
                showAlert('success', result.message);
                
                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
                document.getElementById('new-model-name').value = '';
                
                // ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                await loadProviderModels(currentModelProvider);
                
                // LLMè¨­å®šã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®šã‚‚æ›´æ–°
                await loadLLMConfig();
                
            } catch (error) {
                console.error('ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', `ãƒ¢ãƒ‡ãƒ«è¿½åŠ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã‚’å‰Šé™¤
        async function removeCustomModel(provider, modelName) {
            if (!confirm(`${modelName} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/llm/models/${provider}/${encodeURIComponent(modelName)}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'ãƒ¢ãƒ‡ãƒ«å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const result = await response.json();
                showAlert('success', result.message);
                
                // ãƒ¢ãƒ‡ãƒ«ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                await loadProviderModels(provider);
                
                // LLMè¨­å®šã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼è¨­å®šã‚‚æ›´æ–°
                await loadLLMConfig();
                
            } catch (error) {
                console.error('ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', `ãƒ¢ãƒ‡ãƒ«å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        // Ollamaã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿
        async function loadOllamaInstalledModels() {
            try {
                const response = await fetch('/api/llm/ollama/installed-models');
                const data = await response.json();
                
                const installedList = document.getElementById('installed-models-list');
                installedList.innerHTML = '';
                
                if (data.models.length > 0) {
                    data.models.forEach(model => {
                        const modelItem = document.createElement('div');
                        modelItem.className = 'd-flex justify-content-between align-items-center bg-success bg-opacity-10 p-2 rounded mb-1';
                        modelItem.innerHTML = `
                            <span>
                                <i class="bi bi-hdd text-success"></i>
                                ${model}
                            </span>
                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                    onclick="addModelFromOllama('${model}')">
                                <i class="bi bi-plus"></i>
                                è¿½åŠ 
                            </button>
                        `;
                        installedList.appendChild(modelItem);
                    });
                } else {
                    installedList.innerHTML = '<div class="text-muted text-center py-3">Ollamaãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
                }
                
            } catch (error) {
                console.error('Ollamaãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                const installedList = document.getElementById('installed-models-list');
                installedList.innerHTML = '<div class="text-danger text-center py-3">Ollamaã«æ¥ç¶šã§ãã¾ã›ã‚“</div>';
            }
        }

        // Ollamaãƒ¢ãƒ‡ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã«è¿½åŠ 
        async function addModelFromOllama(modelName) {
            document.getElementById('new-model-name').value = modelName;
            await addCustomModel();
        }

        // Ollamaãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ï¼ˆãƒœã‚¿ãƒ³ç”¨ï¼‰
        async function loadOllamaModels() {
            showAlert('info', 'Ollamaãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...', 2000);
            await loadOllamaInstalledModels();
        }

        // å•†å“ã‹ã‚‰ç›´æ¥æŠ•ç¨¿ç”Ÿæˆï¼ˆå•†å“ã‚«ãƒ¼ãƒ‰ã®ãƒœã‚¿ãƒ³ç”¨ï¼‰
        async function generateFromProduct(productId) {
            // å•†å“ã‚’é¸æŠ
            const selectEl = document.getElementById('selected-product');
            selectEl.value = productId;
            
            // é¸æŠã•ã‚ŒãŸå•†å“ã®æƒ…å ±ã‚’ãƒ­ã‚°å‡ºåŠ›
            const selectedProduct = affiliateProducts.find(p => p.id === productId);
            console.log('å•†å“ã‹ã‚‰ç›´æ¥ç”Ÿæˆ:', {
                productId: productId,
                productName: selectedProduct ? (selectedProduct.name || selectedProduct.title) : 'Unknown',
                hasProduct: !!selectedProduct
            });
            
            // å˜ä½“æŠ•ç¨¿ç”Ÿæˆã‚’å®Ÿè¡Œ
            await generateSinglePost();
        }

        // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ãƒ‡ãƒãƒƒã‚°ã‚’è¡¨ç¤º
        async function showDebugLogs() {
            try {
                showAlert('info', 'ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ã‚’å–å¾—ä¸­...', 2000);
                
                const response = await fetch('/api/llm/debug/system-status');
                const debugData = await response.json();
                
                console.log('=== ã‚·ã‚¹ãƒ†ãƒ è©³ç´°ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===', debugData);
                
                let message = '=== ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ãƒ‡ãƒãƒƒã‚° ===\n\n';
                
                if (debugData.error) {
                    message += `ã€ã‚¨ãƒ©ãƒ¼ã€‘\n${debugData.error}\n`;
                    if (debugData.traceback) {
                        console.error('ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:', debugData.traceback);
                    }
                } else {
                    // LLMè¨­å®šçŠ¶æ³
                    message += 'ã€LLMè¨­å®šçŠ¶æ³ã€‘\n';
                    Object.entries(debugData.llm_config || {}).forEach(([provider, config]) => {
                        const hasApiKey = config.api_key ? 'âœ…' : 'âŒ';
                        const hasModel = config.model ? 'âœ…' : 'âŒ';
                        message += `${provider.toUpperCase()}: API Key ${hasApiKey}, Model ${hasModel} (${config.model || 'ãªã—'})\n`;
                    });
                    
                    // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ©ç”¨å¯èƒ½æ€§
                    message += '\nã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼çŠ¶æ³ã€‘\n';
                    (debugData.providers || []).forEach(provider => {
                        const status = provider.available ? 'âœ… åˆ©ç”¨å¯èƒ½' : 'âŒ è¨­å®šä¸å®Œå…¨';
                        message += `${provider.display_name}: ${status}\n`;
                    });
                    
                    // Ollamaè©³ç´°æƒ…å ±
                    if (debugData.ollama_detailed) {
                        message += '\nã€Ollamaè©³ç´°ã€‘\n';
                        if (debugData.ollama_detailed.error) {
                            message += `âŒ ã‚¨ãƒ©ãƒ¼: ${debugData.ollama_detailed.error}\n`;
                        } else {
                            message += `Base URL: ${debugData.ollama_detailed.base_url}\n`;
                            message += `ãƒ¢ãƒ‡ãƒ«æ•°: ${debugData.ollama_detailed.model_count}\n`;
                            if (debugData.ollama_detailed.available_models.length > 0) {
                                message += `åˆ©ç”¨å¯èƒ½ãƒ¢ãƒ‡ãƒ«: ${debugData.ollama_detailed.available_models.slice(0, 3).join(', ')}`;
                                if (debugData.ollama_detailed.available_models.length > 3) {
                                    message += ` ä»–${debugData.ollama_detailed.available_models.length - 3}å€‹`;
                                }
                                message += '\n';
                            }
                            
                            const connTest = debugData.ollama_detailed.connection_test;
                            if (connTest && connTest.connected !== undefined) {
                                message += `æ¥ç¶šãƒ†ã‚¹ãƒˆ: ${connTest.connected ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}\n`;
                                if (!connTest.connected && connTest.error) {
                                    message += `æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${connTest.error}\n`;
                                }
                            }
                        }
                    }
                    
                    // ç’°å¢ƒå¤‰æ•°çŠ¶æ³
                    message += '\nã€ç’°å¢ƒå¤‰æ•°ã€‘\n';
                    Object.entries(debugData.system?.environment_vars || {}).forEach(([key, value]) => {
                        message += `${key}: ${value}\n`;
                    });
                    
                    // ãƒ­ã‚°è¨­å®š
                    message += '\nã€ãƒ­ã‚°è¨­å®šã€‘\n';
                    message += `ãƒ¬ãƒ™ãƒ«: ${debugData.logging?.level_name || 'Unknown'}\n`;
                    message += `ãƒãƒ³ãƒ‰ãƒ©ãƒ¼æ•°: ${debugData.logging?.handlers?.length || 0}\n`;
                }
                
                console.log(message);
                showAlert('info', message, 20000);
                
            } catch (error) {
                console.error('ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', 'ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // LLMç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
        async function testGenerationProcess() {
            try {
                showAlert('info', 'LLMç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹ã‚’ãƒ†ã‚¹ãƒˆä¸­...', 3000);
                
                const response = await fetch('/api/llm/debug/test-generation', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                console.log('=== ç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹ãƒ†ã‚¹ãƒˆçµæœ ===', result);
                
                let message = '=== LLMç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹ãƒ†ã‚¹ãƒˆçµæœ ===\n\n';
                
                if (result.error) {
                    message += `ã€ã‚¨ãƒ©ãƒ¼ã€‘\n${result.error}\n`;
                    if (result.traceback) {
                        console.error('ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼è©³ç´°:', result.traceback);
                    }
                } else {
                    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°è¡¨ç¤º
                    if (result.debug_log && result.debug_log.length > 0) {
                        message += 'ã€å®Ÿè¡Œãƒ­ã‚°ã€‘\n';
                        result.debug_log.forEach(log => {
                            message += `${log}\n`;
                        });
                        message += '\n';
                    }
                    
                    // ç”Ÿæˆçµæœã‚µãƒãƒªãƒ¼
                    if (result.generation_results) {
                        message += 'ã€ç”Ÿæˆçµæœã‚µãƒãƒªãƒ¼ã€‘\n';
                        Object.entries(result.generation_results).forEach(([provider, genResult]) => {
                            if (genResult.success) {
                                const contentLength = genResult.content ? genResult.content.length : 0;
                                message += `âœ… ${provider.toUpperCase()}: æˆåŠŸ (${contentLength}æ–‡å­—)\n`;
                                if (genResult.content) {
                                    const preview = genResult.content.length > 50 ? 
                                        genResult.content.substring(0, 50) + '...' : 
                                        genResult.content;
                                    message += `   å†…å®¹: "${preview}"\n`;
                                }
                            } else {
                                message += `âŒ ${provider.toUpperCase()}: å¤±æ•—\n`;
                                if (genResult.error) {
                                    message += `   ã‚¨ãƒ©ãƒ¼: ${genResult.error}\n`;
                                }
                            }
                        });
                        message += '\n';
                    }
                    
                    // åˆ©ç”¨å¯èƒ½ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
                    if (result.available_providers) {
                        message += `ã€åˆ©ç”¨å¯èƒ½ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã€‘\n${result.available_providers.join(', ')}\n\n`;
                    }
                    
                    // æˆåŠŸã—ãŸå ´åˆã®æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
                    const successfulProviders = Object.entries(result.generation_results || {})
                        .filter(([_, genResult]) => genResult.success)
                        .map(([provider, _]) => provider);
                    
                    if (successfulProviders.length > 0) {
                        message += `âœ… ${successfulProviders.join(', ')} ã§ç”ŸæˆæˆåŠŸï¼ã“ã‚Œã‚‰ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚`;
                    } else {
                        message += 'âŒ ã™ã¹ã¦ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã§ç”Ÿæˆå¤±æ•—ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                    }
                }
                
                console.log(message);
                showAlert(result.success ? 'success' : 'warning', message, 25000);
                
            } catch (error) {
                console.error('ç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', 'ç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹ãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // Ollamaç°¡å˜æŠ•ç¨¿ç”Ÿæˆãƒ†ã‚¹ãƒˆ
        async function quickOllamaTest() {
            try {
                showAlert('info', 'Ollamaã§æŠ•ç¨¿ç”Ÿæˆã‚’ãƒ†ã‚¹ãƒˆä¸­...', 3000);
                
                const response = await fetch('/api/llm/quick-ollama-test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                console.log('=== Ollamaç°¡å˜ãƒ†ã‚¹ãƒˆçµæœ ===', result);
                
                if (result.success) {
                    let message = 'âœ… OllamaæŠ•ç¨¿ç”ŸæˆæˆåŠŸï¼\n\n';
                    message += `ã€ä½¿ç”¨ãƒ¢ãƒ‡ãƒ«ã€‘\n${result.model_used}\n\n`;
                    message += `ã€ç”Ÿæˆã•ã‚ŒãŸæŠ•ç¨¿ã€‘\n"${result.content}"\n\n`;
                    message += `ã€åˆ©ç”¨å¯èƒ½ãƒ¢ãƒ‡ãƒ«ã€‘\n${result.available_models.join(', ')}\n\n`;
                    message += `${result.message}`;
                    
                    showAlert('success', message, 15000);
                    
                    // ç”Ÿæˆçµæœã‚’è¡¨ç¤ºã‚¨ãƒªã‚¢ã«ã‚‚è¡¨ç¤º
                    if (typeof showGenerationResult === 'function') {
                        showGenerationResult(result.content, {
                            product_name: 'ãƒ†ã‚¹ãƒˆå•†å“',
                            category: 'ãƒ†ã‚¹ãƒˆ'
                        });
                    }
                } else {
                    let message = 'âŒ OllamaæŠ•ç¨¿ç”Ÿæˆå¤±æ•—\n\n';
                    message += `ã€ã‚¨ãƒ©ãƒ¼ã€‘\n${result.error}\n\n`;
                    
                    if (result.available_models && result.available_models.length > 0) {
                        message += `ã€åˆ©ç”¨å¯èƒ½ãƒ¢ãƒ‡ãƒ«ã€‘\n${result.available_models.join(', ')}\n\n`;
                        message += 'åˆ©ç”¨å¯èƒ½ãªãƒ¢ãƒ‡ãƒ«ã¯ã‚ã‚Šã¾ã™ãŒã€ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
                    } else {
                        message += 'ã€å¯¾å‡¦æ³•ã€‘\n';
                        message += '1. OllamaãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª\n';
                        message += '2. `ollama pull llama2` ã¾ãŸã¯ `ollama pull gemma3:27b` ã§ãƒ¢ãƒ‡ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«\n';
                        message += '3. Ollamaã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª (`ollama serve`)';
                    }
                    
                    showAlert('warning', message, 15000);
                }
                
            } catch (error) {
                console.error('Ollamaç°¡å˜ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', 'Ollamaç°¡å˜ãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // Ollamaå°‚ç”¨æ¥ç¶šãƒ†ã‚¹ãƒˆ
        async function testOllamaConnection() {
            try {
                showAlert('info', 'Ollamaæ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...', 2000);
                
                const response = await fetch('/api/llm/test-connection/ollama', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.connected) {
                    let message = 'Ollamaæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼';
                    
                    if (result.available_models !== undefined) {
                        message += `\nåˆ©ç”¨å¯èƒ½ãƒ¢ãƒ‡ãƒ«: ${result.available_models} å€‹`;
                        if (result.test_model) {
                            message += `\nãƒ†ã‚¹ãƒˆãƒ¢ãƒ‡ãƒ«: ${result.test_model}`;
                        }
                    }
                    
                    showAlert('success', message);
                } else {
                    let errorMsg = 'Ollamaæ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—';
                    if (result.error) {
                        errorMsg += `\nè©³ç´°: ${result.error}`;
                    }
                    showAlert('warning', errorMsg);
                }
                
            } catch (error) {
                console.error('Ollamaæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showAlert('danger', 'Ollamaæ¥ç¶šãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }
        }

        // === AIæŠ•ç¨¿ç”Ÿæˆè¨­å®šè¨ºæ–­ ===
        
        // è¨­å®šè¨ºæ–­
        async function diagnoseGenerationSettings() {
            console.log('=== AIæŠ•ç¨¿ç”Ÿæˆè¨­å®šè¨ºæ–­é–‹å§‹ ===');
            
            let diagnostics = [];
            let issues = [];
            
            // 1. Google Sheetsæ¥ç¶šçŠ¶æ…‹
            if (isConnected) {
                diagnostics.push('âœ… Google Sheets API: æ¥ç¶šæ¸ˆã¿');
            } else {
                issues.push('âŒ Google Sheets API: æœªæ¥ç¶š');
            }
            
            // 2. å•†å“ãƒ‡ãƒ¼ã‚¿
            if (affiliateProducts.length > 0) {
                diagnostics.push(`âœ… å•†å“ãƒ‡ãƒ¼ã‚¿: ${affiliateProducts.length} ä»¶èª­ã¿è¾¼ã¿æ¸ˆã¿`);
            } else {
                issues.push('âŒ å•†å“ãƒ‡ãƒ¼ã‚¿: æœªèª­ã¿è¾¼ã¿');
            }
            
            // 3. å•†å“é¸æŠ
            const productId = document.getElementById('selected-product').value;
            if (productId) {
                const selectedProduct = affiliateProducts.find(p => p.id === productId);
                if (selectedProduct) {
                    diagnostics.push(`âœ… å•†å“é¸æŠ: ${selectedProduct.name || selectedProduct.title || 'Unknown'}`);
                } else {
                    issues.push('âŒ å•†å“é¸æŠ: é¸æŠã•ã‚ŒãŸå•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } else {
                issues.push('âŒ å•†å“é¸æŠ: å•†å“ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }
            
            // 4. LLMè¨­å®š
            const settings = getGenerationSettings();
            if (settings.provider) {
                try {
                    const llmConfigResponse = await fetch('/api/llm/config');
                    const llmConfig = await llmConfigResponse.json();
                    const selectedProvider = llmConfig.available_providers.find(p => p.name === settings.provider);
                    
                    if (selectedProvider && selectedProvider.available) {
                        diagnostics.push(`âœ… LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: ${settings.provider.toUpperCase()} (è¨­å®šæ¸ˆã¿)`);
                    } else {
                        issues.push(`âŒ LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: ${settings.provider.toUpperCase()} (è¨­å®šä¸å®Œå…¨)`);
                    }
                } catch (error) {
                    issues.push('âŒ LLMè¨­å®š: è¨­å®šç¢ºèªã‚¨ãƒ©ãƒ¼');
                }
            } else {
                issues.push('âŒ LLMãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼: æœªé¸æŠ');
            }
            
            // 5. ç”Ÿæˆè¨­å®š
            if (settings.post_type && settings.tone && settings.target_audience) {
                diagnostics.push(`âœ… ç”Ÿæˆè¨­å®š: ã‚¿ã‚¤ãƒ—=${settings.post_type}, ãƒˆãƒ¼ãƒ³=${settings.tone}`);
            } else {
                issues.push('âŒ ç”Ÿæˆè¨­å®š: è¨­å®šãŒä¸å®Œå…¨');
            }
            
            // çµæœè¡¨ç¤º
            let message = '=== AIæŠ•ç¨¿ç”Ÿæˆè¨­å®šè¨ºæ–­çµæœ ===\n\n';
            
            if (diagnostics.length > 0) {
                message += 'ã€æ­£å¸¸é …ç›®ã€‘\n' + diagnostics.join('\n') + '\n\n';
            }
            
            if (issues.length > 0) {
                message += 'ã€è¦ä¿®æ­£é …ç›®ã€‘\n' + issues.join('\n') + '\n\n';
                message += 'ã€æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã€‘\n';
                
                if (issues.some(i => i.includes('Google Sheets'))) {
                    message += 'â€¢ Google Sheetsè¨­å®šã‚’å®Œäº†ã—ã¦ãã ã•ã„\n';
                }
                if (issues.some(i => i.includes('å•†å“ãƒ‡ãƒ¼ã‚¿'))) {
                    message += 'â€¢ ã‚¢ãƒ•ã‚£ãƒªå•†å“ç®¡ç†ã‚¿ãƒ–ã§å•†å“ã‚’èª­ã¿è¾¼ã‚“ã§ãã ã•ã„\n';
                }
                if (issues.some(i => i.includes('å•†å“é¸æŠ'))) {
                    message += 'â€¢ å•†å“é¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‹ã‚‰å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„\n';
                }
                if (issues.some(i => i.includes('LLM'))) {
                    message += 'â€¢ LLMè¨­å®šã§APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„\n';
                }
            } else {
                message += 'ğŸ‰ ã™ã¹ã¦ã®è¨­å®šãŒæ­£å¸¸ã§ã™ï¼æŠ•ç¨¿ç”Ÿæˆã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚';
            }
            
            console.log(message);
            showAlert(issues.length > 0 ? 'warning' : 'success', message, 10000);
        }
    </script>
</body>
</html>