<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 0.25rem;
        }
        .bot-card {
            border-left: 4px solid #28a745;
            transition: transform 0.2s;
        }
        .bot-card:hover {
            transform: translateY(-2px);
        }
        .bot-status {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-active { background-color: #28a745; }
        .status-inactive { background-color: #dc3545; }
        .status-paused { background-color: #ffc107; }
        .status-error { background-color: #fd7e14; }
        .image-preview {
            position: relative;
            display: inline-block;
            margin: 0.25rem;
        }
        .image-preview img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 0.375rem;
            border: 2px solid #dee2e6;
        }
        .image-preview .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 0.75rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- サイドバー -->
            <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky pt-3">
                    <div class="text-center mb-4">
                        <h4 class="text-white">
                            <i class="bi bi-robot"></i>
                            Auto Tweeter
                        </h4>
                    </div>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/">
                                <i class="bi bi-speedometer2"></i>
                                ダッシュボード
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="/bots">
                                <i class="bi bi-robot"></i>
                                ボット管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/twitter">
                                <i class="bi bi-twitter"></i>
                                Twitter連携
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/sheets">
                                <i class="bi bi-table"></i>
                                スプレッドシート連携
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/posts">
                                <i class="bi bi-chat-square-text"></i>
                                投稿履歴
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/analytics">
                                <i class="bi bi-graph-up"></i>
                                分析
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/settings">
                                <i class="bi bi-gear"></i>
                                設定
                            </a>
                        </li>
                    </ul>
                    
                    <hr class="my-3 text-white-50">
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/docs" target="_blank">
                                <i class="bi bi-book"></i>
                                API ドキュメント
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- メインコンテンツ -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">
                        <i class="bi bi-robot text-primary"></i>
                        ボット管理
                    </h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-primary" onclick="createNewBot()">
                                <i class="bi bi-plus-circle"></i>
                                新しいボット作成
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshBots()">
                                <i class="bi bi-arrow-clockwise"></i>
                                更新
                            </button>
                        </div>
                    </div>
                </div>

                <!-- ボット統計 -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card bot-card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-robot text-success me-3" style="font-size: 2rem;"></i>
                                    <div>
                                        <h6 class="card-title mb-1">アクティブボット</h6>
                                        <h4 class="text-success mb-0" id="active-bots-count">0</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card bot-card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-pause-circle text-warning me-3" style="font-size: 2rem;"></i>
                                    <div>
                                        <h6 class="card-title mb-1">停止中ボット</h6>
                                        <h4 class="text-warning mb-0" id="inactive-bots-count">0</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card bot-card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-list text-info me-3" style="font-size: 2rem;"></i>
                                    <div>
                                        <h6 class="card-title mb-1">総ボット数</h6>
                                        <h4 class="text-info mb-0" id="total-bots-count">0</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6 mb-3">
                        <div class="card bot-card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-chat-square-text text-primary me-3" style="font-size: 2rem;"></i>
                                    <div>
                                        <h6 class="card-title mb-1">今日の投稿</h6>
                                        <h4 class="text-primary mb-0" id="today-posts-count">0</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ボット一覧 -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-list"></i>
                                    ボット一覧
                                </h5>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="filterBots('all')">
                                        すべて
                                    </button>
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="filterBots('active')">
                                        アクティブ
                                    </button>
                                    <button type="button" class="btn btn-outline-warning btn-sm" onclick="filterBots('inactive')">
                                        停止中
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div id="bots-list">
                                    <div class="text-center py-5">
                                        <i class="bi bi-arrow-clockwise"></i>
                                        読み込み中...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 手動投稿モーダル -->
    <div class="modal fade" id="manualPostModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-chat-square-text"></i>
                        手動投稿
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="manualPostForm">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <label class="form-label">投稿タイプ</label>
                                <div class="btn-group btn-group-sm" role="group">
                                    <input type="radio" class="btn-check" name="postType" id="singlePost" value="single" checked>
                                    <label class="btn btn-outline-primary" for="singlePost">単体投稿</label>
                                    
                                    <input type="radio" class="btn-check" name="postType" id="threadPost" value="thread">
                                    <label class="btn btn-outline-primary" for="threadPost">ツリー投稿</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 単体投稿フォーム -->
                        <div id="singlePostForm" class="post-type-form">
                            <div class="mb-3">
                                <label for="postContent" class="form-label">投稿内容</label>
                                <textarea class="form-control" id="postContent" rows="4" maxlength="280" required></textarea>
                                <div class="form-text">
                                    <span id="charCount">0</span>/280文字
                                </div>
                            </div>
                        </div>
                        
                        <!-- ツリー投稿フォーム -->
                        <div id="threadPostForm" class="post-type-form" style="display: none;">
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <label class="form-label">ツリー投稿内容</label>
                                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addThreadPost()">
                                        <i class="bi bi-plus"></i> 追加
                                    </button>
                                </div>
                                <div id="threadContents">
                                    <div class="thread-item mb-3">
                                        <label class="form-label text-muted">1番目の投稿</label>
                                        <div class="input-group">
                                            <textarea class="form-control thread-content" rows="3" maxlength="280" placeholder="最初の投稿内容..."></textarea>
                                            <button class="btn btn-outline-danger" type="button" onclick="removeThreadPost(this)" style="display: none;">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                        <div class="form-text">
                                            <span class="thread-char-count">0</span>/280文字
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-info">
                                    <small>
                                        <i class="bi bi-info-circle"></i>
                                        ツリー投稿では複数のツイートが順番に投稿され、前のツイートに返信する形で連結されます。
                                    </small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 画像アップロード -->
                        <div class="mb-3">
                            <label class="form-label">画像を添付</label>
                            <div class="d-flex gap-2">
                                <input type="file" class="form-control" id="imageUpload" accept="image/*" multiple onchange="handleImageUpload(event)">
                                <button type="button" class="btn btn-outline-danger" onclick="clearImages()" id="clearImagesBtn" style="display: none;">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                            <div class="form-text">JPG、PNG、GIF、WebP形式をサポート。最大4枚まで。</div>
                            <div id="imagePreview" class="mt-2"></div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="useTemplate">
                                <label class="form-check-label" for="useTemplate">
                                    ボットのテンプレートを使用
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="submitManualPost()">
                        <i class="bi bi-send"></i>
                        <span id="postButtonText">投稿</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ボット編集モーダル -->
    <div class="modal fade" id="editBotModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil"></i>
                        ボット編集
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editBotForm">
                        <input type="hidden" id="editBotId">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editBotName" class="form-label">ボット名</label>
                                    <input type="text" class="form-control" id="editBotName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTwitterAccount" class="form-label">Twitterアカウント</label>
                                    <select class="form-select" id="editTwitterAccount" required>
                                        <option value="">選択してください</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editBotDescription" class="form-label">説明</label>
                            <textarea class="form-control" id="editBotDescription" rows="3"></textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editPostingInterval" class="form-label">投稿間隔（分）</label>
                                    <input type="number" class="form-control" id="editPostingInterval" min="1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editMaxPosts" class="form-label">1日の最大投稿数</label>
                                    <input type="number" class="form-control" id="editMaxPosts" min="1">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editContentTemplate" class="form-label">投稿テンプレート</label>
                            <textarea class="form-control" id="editContentTemplate" rows="4"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editIsActive">
                                <label class="form-check-label" for="editIsActive">
                                    アクティブ
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="submitEditBot()">
                        <i class="bi bi-check"></i>
                        更新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新規ボット作成モーダル -->
    <div class="modal fade" id="createBotModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-robot"></i>
                        新しいボット作成
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createBotForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="botName" class="form-label">ボット名</label>
                                    <input type="text" class="form-control" id="botName" required>
                                    <div class="form-text">ボットの識別名</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="twitterAccount" class="form-label">Twitterアカウント</label>
                                    <select class="form-select" id="twitterAccount" required>
                                        <option value="">選択してください</option>
                                    </select>
                                    <div class="form-text">投稿に使用するTwitterアカウント</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="botDescription" class="form-label">説明</label>
                            <textarea class="form-control" id="botDescription" rows="3"></textarea>
                            <div class="form-text">ボットの目的や動作内容の説明</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="postingInterval" class="form-label">投稿間隔（分）</label>
                                    <input type="number" class="form-control" id="postingInterval" min="1" value="60">
                                    <div class="form-text">自動投稿の間隔</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="maxPosts" class="form-label">1日の最大投稿数</label>
                                    <input type="number" class="form-control" id="maxPosts" min="1" value="10">
                                    <div class="form-text">1日あたりの投稿上限</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="contentTemplate" class="form-label">投稿テンプレート</label>
                            <textarea class="form-control" id="contentTemplate" rows="4" placeholder="こんにちは！今日も良い一日を！ #bot #挨拶"></textarea>
                            <div class="form-text">投稿する内容のテンプレート</div>
                        </div>
                        
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="autoStart">
                                <label class="form-check-label" for="autoStart">
                                    作成後すぐに開始する
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-primary" onclick="submitCreateBot()">
                        <i class="bi bi-plus-circle"></i>
                        作成
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentFilter = 'all';
        let allBots = [];

        // ボット一覧の更新
        async function refreshBots() {
            try {
                const response = await fetch('/api/bots');
                if (response.ok) {
                    allBots = await response.json();
                    renderBotsList(allBots);
                    updateBotStats(allBots);
                } else {
                    console.error('ボット情報の取得に失敗しました');
                    renderErrorState();
                }
            } catch (error) {
                console.error('API呼び出しエラー:', error);
                renderErrorState();
            }
        }

        // ボット統計の更新
        function updateBotStats(bots) {
            const activeBots = bots.filter(bot => bot.status === 'active').length;
            const inactiveBots = bots.filter(bot => bot.status === 'inactive').length;
            const totalBots = bots.length;
            
            document.getElementById('active-bots-count').textContent = activeBots;
            document.getElementById('inactive-bots-count').textContent = inactiveBots;
            document.getElementById('total-bots-count').textContent = totalBots;
            document.getElementById('today-posts-count').textContent = '0'; // TODO: 実装
        }

        // ボット一覧の描画
        function renderBotsList(bots) {
            const botsList = document.getElementById('bots-list');
            
            if (!bots || bots.length === 0) {
                botsList.innerHTML = `
                    <div class="text-center py-5 text-muted">
                        <i class="bi bi-robot" style="font-size: 4rem;"></i>
                        <h4 class="mt-3">ボットがまだ作成されていません</h4>
                        <p>最初のボットを作成して自動投稿を開始しましょう</p>
                        <button class="btn btn-primary" onclick="createNewBot()">
                            <i class="bi bi-plus-circle"></i>
                            最初のボットを作成
                        </button>
                    </div>
                `;
                return;
            }

            const botsHtml = bots.map(bot => `
                <div class="d-flex align-items-center justify-content-between p-3 border-bottom bot-item" data-status="${bot.status || 'inactive'}">
                    <div class="d-flex align-items-center">
                        <span class="bot-status status-${bot.status || 'inactive'}"></span>
                        <div class="me-3">
                            <i class="bi bi-robot text-primary" style="font-size: 2rem;"></i>
                        </div>
                        <div>
                            <h6 class="mb-1">${bot.name || 'Unnamed Bot'}</h6>
                            <small class="text-muted">${bot.description || 'No description'}</small>
                            <div class="mt-1">
                                <small class="badge bg-${bot.status === 'active' ? 'success' : 'secondary'} me-1">
                                    ${bot.status === 'active' ? 'アクティブ' : '停止中'}
                                </small>
                                ${bot.twitter_account ? `<small class="text-muted">@${bot.twitter_account.username}</small>` : '<small class="text-warning">アカウント未設定</small>'}
                            </div>
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-success" onclick="manualPost('${bot.id}')" title="手動投稿">
                            <i class="bi bi-chat-square-text"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="editBot('${bot.id}')" title="編集">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-${bot.status === 'active' ? 'warning' : 'success'}" 
                                onclick="toggleBot('${bot.id}')" 
                                title="${bot.status === 'active' ? '停止' : '開始'}">
                            <i class="bi bi-${bot.status === 'active' ? 'pause' : 'play'}"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-info" onclick="viewBotStats('${bot.id}')" title="統計">
                            <i class="bi bi-graph-up"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBot('${bot.id}')" title="削除">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');

            botsList.innerHTML = botsHtml;
        }

        // エラー状態の描画
        function renderErrorState() {
            const botsList = document.getElementById('bots-list');
            botsList.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-exclamation-triangle text-warning" style="font-size: 4rem;"></i>
                    <h4 class="mt-3">データの取得に失敗しました</h4>
                    <button class="btn btn-outline-primary" onclick="refreshBots()">
                        <i class="bi bi-arrow-clockwise"></i>
                        再試行
                    </button>
                </div>
            `;
        }

        // ボットフィルタリング
        function filterBots(status) {
            currentFilter = status;
            
            // アクティブボタンの更新
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            if (status === 'all') {
                renderBotsList(allBots);
            } else {
                const filteredBots = allBots.filter(bot => bot.status === status);
                renderBotsList(filteredBots);
            }
        }

        // 新規ボット作成
        async function createNewBot() {
            // Twitterアカウント一覧を取得
            try {
                const response = await fetch('/api/twitter/accounts');
                if (response.ok) {
                    const accounts = await response.json();
                    const select = document.getElementById('twitterAccount');
                    select.innerHTML = '<option value="">選択してください</option>';
                    
                    accounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.id;
                        option.textContent = `@${account.username} (${account.display_name})`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Twitterアカウントの取得に失敗:', error);
            }
            
            const modal = new bootstrap.Modal(document.getElementById('createBotModal'));
            modal.show();
        }

        // ボット作成フォーム送信
        async function submitCreateBot() {
            const form = document.getElementById('createBotForm');
            const formData = new FormData(form);
            
            const botData = {
                name: document.getElementById('botName').value,
                description: document.getElementById('botDescription').value,
                twitter_account_id: document.getElementById('twitterAccount').value,
                posting_interval: parseInt(document.getElementById('postingInterval').value),
                max_posts_per_day: parseInt(document.getElementById('maxPosts').value),
                content_template: document.getElementById('contentTemplate').value,
                is_active: document.getElementById('autoStart').checked
            };

            try {
                const response = await fetch('/api/bots', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(botData)
                });

                if (response.ok) {
                    const result = await response.json();
                    bootstrap.Modal.getInstance(document.getElementById('createBotModal')).hide();
                    form.reset();
                    refreshBots();
                    showAlert('success', 'ボットが正常に作成されました！');
                } else {
                    const error = await response.json();
                    showAlert('danger', `作成に失敗しました: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('作成エラー:', error);
                showAlert('danger', '作成処理中にエラーが発生しました');
            }
        }

        let currentBotId = null;
        let uploadedImages = [];

        // 手動投稿
        async function manualPost(botId) {
            currentBotId = botId;
            
            // フォームをリセット
            resetPostForm();
            
            // ボット情報を取得してテンプレートを表示
            const bot = allBots.find(b => b.id === botId);
            if (bot && bot.content_template) {
                document.getElementById('postContent').value = bot.content_template;
                updateCharCount();
            } else {
                document.getElementById('postContent').value = '';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('manualPostModal'));
            modal.show();
        }

        // 文字数カウント更新
        function updateCharCount() {
            const content = document.getElementById('postContent').value;
            document.getElementById('charCount').textContent = content.length;
        }

        // テンプレート使用チェックボックスの処理
        document.getElementById('useTemplate').addEventListener('change', function() {
            if (this.checked && currentBotId) {
                const bot = allBots.find(b => b.id === currentBotId);
                if (bot && bot.content_template) {
                    document.getElementById('postContent').value = bot.content_template;
                    updateCharCount();
                }
            }
        });

        // 文字数カウントのリアルタイム更新
        document.getElementById('postContent').addEventListener('input', updateCharCount);

        // 画像アップロード処理
        async function handleImageUpload(event) {
            const files = Array.from(event.target.files);
            
            if (uploadedImages.length + files.length > 4) {
                showAlert('warning', '画像は最大4枚まで選択できます');
                event.target.value = '';
                return;
            }
            
            for (const file of files) {
                try {
                    const formData = new FormData();
                    formData.append('file', file);
                    
                    const response = await fetch('/api/upload/image', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        uploadedImages.push({
                            id: result.file_id,
                            url: result.url,
                            filename: result.filename
                        });
                        updateImagePreview();
                    } else {
                        const error = await response.json();
                        showAlert('danger', `画像のアップロードに失敗しました: ${error.detail}`);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    showAlert('danger', '画像のアップロードに失敗しました');
                }
            }
            
            // ファイル入力をクリア
            event.target.value = '';
        }

        // 画像プレビューの更新
        function updateImagePreview() {
            const preview = document.getElementById('imagePreview');
            const clearBtn = document.getElementById('clearImagesBtn');
            
            if (uploadedImages.length === 0) {
                preview.innerHTML = '';
                clearBtn.style.display = 'none';
                return;
            }
            
            clearBtn.style.display = 'block';
            
            const imagesHtml = uploadedImages.map((image, index) => `
                <div class="image-preview">
                    <img src="${image.url}" alt="アップロード画像 ${index + 1}">
                    <button type="button" class="remove-image" onclick="removeImage(${index})" title="削除">
                        ×
                    </button>
                </div>
            `).join('');
            
            preview.innerHTML = imagesHtml;
        }

        // 個別画像を削除
        function removeImage(index) {
            uploadedImages.splice(index, 1);
            updateImagePreview();
        }

        // 全画像をクリア
        function clearImages() {
            uploadedImages = [];
            updateImagePreview();
            document.getElementById('imageUpload').value = '';
        }

        // 投稿フォームのリセット
        function resetPostForm() {
            // 単体投稿をデフォルトで選択
            document.getElementById('singlePost').checked = true;
            document.getElementById('threadPost').checked = false;
            
            // フォームの表示切り替え
            showPostTypeForm();
            
            // フォームをクリア
            document.getElementById('postContent').value = '';
            document.getElementById('useTemplate').checked = false;
            
            // ツリー投稿をリセット
            resetThreadForm();
            
            // 画像をクリア
            clearImages();
            
            updateCharCount();
            updatePostButtonText();
        }

        // 投稿タイプ切り替え
        function showPostTypeForm() {
            const postType = document.querySelector('input[name="postType"]:checked').value;
            const singleForm = document.getElementById('singlePostForm');
            const threadForm = document.getElementById('threadPostForm');
            
            if (postType === 'single') {
                singleForm.style.display = 'block';
                threadForm.style.display = 'none';
            } else {
                singleForm.style.display = 'none';
                threadForm.style.display = 'block';
            }
            
            updatePostButtonText();
        }

        // ツリー投稿フォームのリセット
        function resetThreadForm() {
            const threadContents = document.getElementById('threadContents');
            threadContents.innerHTML = `
                <div class="thread-item mb-3">
                    <label class="form-label text-muted">1番目の投稿</label>
                    <div class="input-group">
                        <textarea class="form-control thread-content" rows="3" maxlength="280" placeholder="最初の投稿内容..."></textarea>
                        <button class="btn btn-outline-danger" type="button" onclick="removeThreadPost(this)" style="display: none;">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="form-text">
                        <span class="thread-char-count">0</span>/280文字
                    </div>
                </div>
            `;
            
            // イベントリスナーを再設定
            updateThreadEventListeners();
        }

        // ツリー投稿追加
        function addThreadPost() {
            const threadContents = document.getElementById('threadContents');
            const currentCount = threadContents.children.length;
            
            if (currentCount >= 25) {
                showAlert('warning', 'ツリー投稿は最大25件までです');
                return;
            }
            
            const newThreadItem = document.createElement('div');
            newThreadItem.className = 'thread-item mb-3';
            newThreadItem.innerHTML = `
                <label class="form-label text-muted">${currentCount + 1}番目の投稿</label>
                <div class="input-group">
                    <textarea class="form-control thread-content" rows="3" maxlength="280" placeholder="${currentCount + 1}番目の投稿内容..."></textarea>
                    <button class="btn btn-outline-danger" type="button" onclick="removeThreadPost(this)">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
                <div class="form-text">
                    <span class="thread-char-count">0</span>/280文字
                </div>
            `;
            
            threadContents.appendChild(newThreadItem);
            updateThreadEventListeners();
            updateDeleteButtons();
            updatePostButtonText();
        }

        // ツリー投稿削除
        function removeThreadPost(button) {
            const threadItem = button.closest('.thread-item');
            threadItem.remove();
            
            // ラベルを再設定
            updateThreadLabels();
            updateDeleteButtons();
            updatePostButtonText();
        }

        // ツリー投稿のラベル更新
        function updateThreadLabels() {
            const threadItems = document.querySelectorAll('.thread-item');
            threadItems.forEach((item, index) => {
                const label = item.querySelector('label');
                const textarea = item.querySelector('textarea');
                label.textContent = `${index + 1}番目の投稿`;
                textarea.placeholder = index === 0 ? '最初の投稿内容...' : `${index + 1}番目の投稿内容...`;
            });
        }

        // 削除ボタンの表示制御
        function updateDeleteButtons() {
            const threadItems = document.querySelectorAll('.thread-item');
            threadItems.forEach((item, index) => {
                const deleteButton = item.querySelector('.btn-outline-danger');
                deleteButton.style.display = threadItems.length > 1 ? 'block' : 'none';
            });
        }

        // 投稿ボタンテキスト更新
        function updatePostButtonText() {
            const postType = document.querySelector('input[name="postType"]:checked').value;
            const buttonText = document.getElementById('postButtonText');
            
            if (postType === 'thread') {
                const threadCount = document.querySelectorAll('.thread-item').length;
                buttonText.textContent = `ツリー投稿 (${threadCount}件)`;
            } else {
                buttonText.textContent = '投稿';
            }
        }

        // ツリー投稿の文字数カウント更新
        function updateThreadCharCount(textarea) {
            const charCountSpan = textarea.closest('.thread-item').querySelector('.thread-char-count');
            charCountSpan.textContent = textarea.value.length;
        }

        // ツリー投稿のイベントリスナー更新
        function updateThreadEventListeners() {
            document.querySelectorAll('.thread-content').forEach(textarea => {
                textarea.removeEventListener('input', handleThreadInput);
                textarea.addEventListener('input', handleThreadInput);
            });
        }

        function handleThreadInput(event) {
            updateThreadCharCount(event.target);
        }

        // 手動投稿送信
        async function submitManualPost() {
            const postType = document.querySelector('input[name="postType"]:checked').value;
            let requestData;
            
            if (postType === 'single') {
                const content = document.getElementById('postContent').value.trim();
                
                if (!content) {
                    showAlert('warning', '投稿内容を入力してください');
                    return;
                }
                
                if (content.length > 280) {
                    showAlert('warning', '投稿内容は280文字以内にしてください');
                    return;
                }
                
                requestData = { 
                    content: content,
                    images: uploadedImages.map(img => ({ url: img.url, filename: img.filename }))
                };
            } else {
                // ツリー投稿
                const threadContents = [];
                document.querySelectorAll('.thread-content').forEach(textarea => {
                    const content = textarea.value.trim();
                    if (content) {
                        if (content.length > 280) {
                            showAlert('warning', `${threadContents.length + 1}番目の投稿が280文字を超えています`);
                            return;
                        }
                        threadContents.push(content);
                    }
                });
                
                if (threadContents.length === 0) {
                    showAlert('warning', '投稿内容を入力してください');
                    return;
                }
                
                requestData = { 
                    contents: threadContents,
                    images: uploadedImages.map(img => ({ url: img.url, filename: img.filename }))
                };
            }

            try {
                const response = await fetch(`/api/bots/${currentBotId}/post`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                if (response.ok) {
                    const result = await response.json();
                    bootstrap.Modal.getInstance(document.getElementById('manualPostModal')).hide();
                    document.getElementById('manualPostForm').reset();
                    
                    if (result.thread_url) {
                        showAlert('success', `ツリー投稿しました！(${result.successful_count}/${result.total_count}件)<br><a href="${result.thread_url}" target="_blank">ツリーを見る</a>`);
                    } else if (result.url) {
                        showAlert('success', `投稿しました！<br><a href="${result.url}" target="_blank">ツイートを見る</a>`);
                    } else {
                        showAlert('success', result.message || '投稿しました！');
                    }
                } else {
                    const error = await response.json();
                    showAlert('danger', `投稿に失敗しました: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('投稿エラー:', error);
                showAlert('danger', '投稿処理中にエラーが発生しました');
            }
        }

        // ボット編集
        async function editBot(botId) {
            try {
                // ボット情報を取得
                const bot = allBots.find(b => b.id === botId);
                if (!bot) {
                    showAlert('danger', 'ボット情報が見つかりません');
                    return;
                }

                // Twitterアカウント一覧を取得
                const accountsResponse = await fetch('/api/twitter/accounts');
                if (accountsResponse.ok) {
                    const accounts = await accountsResponse.json();
                    const select = document.getElementById('editTwitterAccount');
                    select.innerHTML = '<option value="">選択してください</option>';
                    
                    accounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account.id;
                        option.textContent = `@${account.username} (${account.display_name})`;
                        if (bot.twitter_account && account.id === bot.twitter_account.id) {
                            option.selected = true;
                        }
                        select.appendChild(option);
                    });
                }

                // フォームに現在の値を設定
                document.getElementById('editBotId').value = bot.id;
                document.getElementById('editBotName').value = bot.name || '';
                document.getElementById('editBotDescription').value = bot.description || '';
                document.getElementById('editPostingInterval').value = bot.posting_interval || '60';
                document.getElementById('editMaxPosts').value = bot.max_posts_per_day || '10';
                document.getElementById('editContentTemplate').value = bot.content_template || '';
                document.getElementById('editIsActive').checked = bot.status === 'active';

                const modal = new bootstrap.Modal(document.getElementById('editBotModal'));
                modal.show();
                
            } catch (error) {
                console.error('編集モーダル表示エラー:', error);
                showAlert('danger', 'ボット編集画面の表示に失敗しました');
            }
        }

        // ボット編集送信
        async function submitEditBot() {
            const botId = document.getElementById('editBotId').value;
            const botData = {
                name: document.getElementById('editBotName').value,
                description: document.getElementById('editBotDescription').value,
                twitter_account_id: document.getElementById('editTwitterAccount').value,
                posting_interval: parseInt(document.getElementById('editPostingInterval').value),
                max_posts_per_day: parseInt(document.getElementById('editMaxPosts').value),
                content_template: document.getElementById('editContentTemplate').value,
                is_active: document.getElementById('editIsActive').checked
            };

            try {
                const response = await fetch(`/api/bots/${botId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(botData)
                });

                if (response.ok) {
                    const result = await response.json();
                    bootstrap.Modal.getInstance(document.getElementById('editBotModal')).hide();
                    refreshBots();
                    showAlert('success', 'ボットを更新しました！');
                } else {
                    const error = await response.json();
                    showAlert('danger', `更新に失敗しました: ${error.detail || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('更新エラー:', error);
                showAlert('danger', '更新処理中にエラーが発生しました');
            }
        }

        // ボットの開始/停止切り替え
        async function toggleBot(botId) {
            try {
                const response = await fetch(`/api/bots/${botId}/toggle`, {
                    method: 'POST'
                });

                if (response.ok) {
                    refreshBots();
                    showAlert('success', 'ボットの状態を切り替えました');
                } else {
                    showAlert('danger', 'ボットの切り替えに失敗しました');
                }
            } catch (error) {
                console.error('切り替えエラー:', error);
                showAlert('danger', '切り替え処理中にエラーが発生しました');
            }
        }

        // ボット統計表示
        function viewBotStats(botId) {
            // TODO: ボット統計機能の実装
            showAlert('info', 'ボット統計機能は準備中です');
        }

        // ボット削除
        async function deleteBot(botId) {
            if (!confirm('このボットを削除しますか？この操作は取り消せません。')) {
                return;
            }

            try {
                const response = await fetch(`/api/bots/${botId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    refreshBots();
                    showAlert('success', 'ボットを削除しました');
                } else {
                    showAlert('danger', 'ボットの削除に失敗しました');
                }
            } catch (error) {
                console.error('削除エラー:', error);
                showAlert('danger', '削除処理中にエラーが発生しました');
            }
        }

        // アラート表示
        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.querySelector('main').insertAdjacentHTML('afterbegin', alertHtml);
        }

        // ページ読み込み時にボット一覧を取得
        document.addEventListener('DOMContentLoaded', function() {
            refreshBots();
            
            // 投稿タイプラジオボタンのイベントリスナー
            document.querySelectorAll('input[name="postType"]').forEach(radio => {
                radio.addEventListener('change', showPostTypeForm);
            });
        });

        // 30秒ごとに自動更新
        setInterval(refreshBots, 30000);
    </script>
</body>
</html>