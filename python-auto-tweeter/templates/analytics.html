<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>
<body class="bg-gray-100">
    <!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <h1 class="text-xl font-bold">
                    <a href="/" class="hover:text-blue-200">Python Auto Tweeter</a>
                </h1>
                <div class="flex space-x-4">
                    <a href="/" class="hover:text-blue-200">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                    <a href="/bots" class="hover:text-blue-200">ãƒœãƒƒãƒˆç®¡ç†</a>
                    <a href="/posts" class="hover:text-blue-200">æŠ•ç¨¿å±¥æ­´</a>
                    <a href="/sheets" class="hover:text-blue-200">ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ</a>
                    <a href="/analytics" class="text-blue-200 font-semibold">åˆ†æ</a>
                    <a href="/twitter" class="hover:text-blue-200">Twitteré€£æº</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8" x-data="analyticsData()">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="mb-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">åˆ†æãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h2>
            <div class="flex flex-wrap gap-4">
                <!-- ãƒœãƒƒãƒˆé¸æŠ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ãƒœãƒƒãƒˆé¸æŠ</label>
                    <select x-model="selectedBot" @change="loadAnalytics()" 
                            class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">å…¨ãƒœãƒƒãƒˆ</option>
                        <template x-for="bot in bots" :key="bot.id">
                            <option :value="bot.id" x-text="bot.name"></option>
                        </template>
                    </select>
                </div>
                
                <!-- æœŸé–“é¸æŠ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">åˆ†ææœŸé–“</label>
                    <select x-model="selectedDays" @change="loadAnalytics()" 
                            class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="7">éå»7æ—¥</option>
                        <option value="30">éå»30æ—¥</option>
                        <option value="90">éå»90æ—¥</option>
                    </select>
                </div>
                
                <!-- æ›´æ–°ãƒœã‚¿ãƒ³ -->
                <div class="flex items-end">
                    <button @click="loadAnalytics()" 
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                        <span x-show="!loading">ãƒ‡ãƒ¼ã‚¿æ›´æ–°</span>
                        <span x-show="loading">èª­ã¿è¾¼ã¿ä¸­...</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- æ¦‚è¦çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" x-show="overview">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">ç·æŠ•ç¨¿æ•°</h3>
                <p class="text-3xl font-bold text-blue-600" x-text="overview?.posts?.total || 0"></p>
                <p class="text-sm text-gray-500 mt-1">
                    æˆåŠŸç‡: <span x-text="(overview?.posts?.success_rate || 0).toFixed(1)"></span>%
                </p>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">å¹³å‡ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ</h3>
                <p class="text-3xl font-bold text-green-600" 
                   x-text="((overview?.engagement?.avg_likes || 0) + (overview?.engagement?.avg_retweets || 0) + (overview?.engagement?.avg_replies || 0)).toFixed(1)"></p>
                <p class="text-sm text-gray-500 mt-1">ã„ã„ã­ãƒ»RTãƒ»è¿”ä¿¡ã®åˆè¨ˆ</p>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">AIç”ŸæˆæŠ•ç¨¿ç‡</h3>
                <p class="text-3xl font-bold text-purple-600" x-text="(overview?.content_types?.ai_ratio || 0).toFixed(1)"></p>
                <p class="text-sm text-gray-500 mt-1">%</p>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">æœ€é©æŠ•ç¨¿æ™‚é–“</h3>
                <p class="text-3xl font-bold text-orange-600" 
                   x-text="timeAnalysis?.best_posting_hours?.slice(0,2).join('æ™‚, ') + 'æ™‚' || '-'"></p>
                <p class="text-sm text-gray-500 mt-1">ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆãŒé«˜ã„æ™‚é–“</p>
            </div>
        </div>

        <!-- ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- æŠ•ç¨¿æ™‚é–“åˆ†æ -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">æ™‚é–“å¸¯åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h3>
                <canvas id="timeChart" width="400" height="200"></canvas>
            </div>

            <!-- ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆæ¨ç§» -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆæ¨ç§»</h3>
                <canvas id="trendChart" width="400" height="200"></canvas>
            </div>
        </div>

        <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ†æ -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8" x-show="contentAnalysis">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">ã‚³ãƒ³ãƒ†ãƒ³ãƒ„åˆ†æ</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- é•·ã•åˆ¥åˆ†æ -->
                <div>
                    <h4 class="font-semibold text-gray-700 mb-3">æŠ•ç¨¿é•·ã•åˆ¥ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm">çŸ­æ–‡ (â‰¤50æ–‡å­—)</span>
                            <span class="text-sm font-medium" 
                                  x-text="(contentAnalysis?.length_analysis?.short_posts?.avg_engagement || 0).toFixed(1)"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">ä¸­æ–‡ (51-150æ–‡å­—)</span>
                            <span class="text-sm font-medium" 
                                  x-text="(contentAnalysis?.length_analysis?.medium_posts?.avg_engagement || 0).toFixed(1)"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">é•·æ–‡ (>150æ–‡å­—)</span>
                            <span class="text-sm font-medium" 
                                  x-text="(contentAnalysis?.length_analysis?.long_posts?.avg_engagement || 0).toFixed(1)"></span>
                        </div>
                    </div>
                </div>

                <!-- ãƒ¡ãƒ‡ã‚£ã‚¢åŠ¹æœ -->
                <div>
                    <h4 class="font-semibold text-gray-700 mb-3">ãƒ¡ãƒ‡ã‚£ã‚¢åŠ¹æœ</h4>
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm">ãƒ¡ãƒ‡ã‚£ã‚¢ã‚ã‚Š</span>
                            <span class="text-sm font-medium" 
                                  x-text="(contentAnalysis?.media_analysis?.avg_engagement_with_media || 0).toFixed(1)"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm">ãƒ¡ãƒ‡ã‚£ã‚¢ãªã—</span>
                            <span class="text-sm font-medium" 
                                  x-text="(contentAnalysis?.media_analysis?.avg_engagement_without_media || 0).toFixed(1)"></span>
                        </div>
                    </div>
                </div>

                <!-- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°åŠ¹æœ -->
                <div>
                    <h4 class="font-semibold text-gray-700 mb-3">ãƒˆãƒƒãƒ—ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°</h4>
                    <div class="space-y-2" x-show="contentAnalysis?.hashtag_analysis?.top_hashtags">
                        <template x-for="hashtag in (contentAnalysis?.hashtag_analysis?.top_hashtags || []).slice(0, 5)" :key="hashtag[0]">
                            <div class="flex justify-between items-center">
                                <span class="text-sm" x-text="hashtag[0]"></span>
                                <span class="text-sm font-medium" x-text="hashtag[1].avg_engagement.toFixed(1)"></span>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¨å¥¨äº‹é … -->
        <div class="bg-white p-6 rounded-lg shadow-md mb-8" x-show="recommendations && recommendations.length > 0">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">æ¨å¥¨äº‹é …</h3>
            <div class="space-y-4">
                <template x-for="rec in recommendations" :key="rec.type">
                    <div class="border-l-4 border-blue-500 pl-4 py-2">
                        <h4 class="font-semibold text-gray-700" x-text="rec.title"></h4>
                        <p class="text-gray-600 text-sm" x-text="rec.description"></p>
                        <span class="inline-block mt-1 px-2 py-1 text-xs rounded-full"
                              :class="{
                                  'bg-red-100 text-red-800': rec.priority === 'high',
                                  'bg-yellow-100 text-yellow-800': rec.priority === 'medium',
                                  'bg-green-100 text-green-800': rec.priority === 'low'
                              }"
                              x-text="rec.priority === 'high' ? 'é‡è¦' : rec.priority === 'medium' ? 'ä¸­' : 'ä½'"></span>
                    </div>
                </template>
            </div>
        </div>

        <!-- ãƒˆãƒƒãƒ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŠ•ç¨¿ -->
        <div class="bg-white p-6 rounded-lg shadow-md" x-show="contentAnalysis?.top_performing_posts">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">ãƒˆãƒƒãƒ—ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŠ•ç¨¿</h3>
            <div class="space-y-4">
                <template x-for="post in (contentAnalysis?.top_performing_posts || [])" :key="post.id">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="text-gray-800" x-text="post.content"></p>
                                <div class="flex space-x-4 mt-2 text-sm text-gray-500">
                                    <span>â¤ï¸ <span x-text="post.likes"></span></span>
                                    <span>ğŸ”„ <span x-text="post.retweets"></span></span>
                                    <span>ğŸ’¬ <span x-text="post.replies"></span></span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm font-medium"
                                      x-text="post.engagement"></span>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        function analyticsData() {
            return {
                selectedBot: '',
                selectedDays: 30,
                loading: false,
                bots: [],
                overview: null,
                timeAnalysis: null,
                contentAnalysis: null,
                recommendations: [],
                timeChart: null,
                trendChart: null,

                async init() {
                    await this.loadBots();
                    await this.loadAnalytics();
                },

                async loadBots() {
                    try {
                        const response = await fetch('/api/bots');
                        const data = await response.json();
                        this.bots = data;
                    } catch (error) {
                        console.error('ãƒœãƒƒãƒˆä¸€è¦§ã®å–å¾—ã«å¤±æ•—:', error);
                    }
                },

                async loadAnalytics() {
                    this.loading = true;
                    
                    try {
                        // ä¸¦è¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                        const [overviewResponse, timeResponse, contentResponse, recResponse] = await Promise.all([
                            fetch(`/api/analytics/overview?${new URLSearchParams({
                                ...(this.selectedBot && { bot_id: this.selectedBot }),
                                days: this.selectedDays
                            })}`),
                            fetch(`/api/analytics/posting-time?${new URLSearchParams({
                                ...(this.selectedBot && { bot_id: this.selectedBot }),
                                days: this.selectedDays
                            })}`),
                            fetch(`/api/analytics/content-performance?${new URLSearchParams({
                                ...(this.selectedBot && { bot_id: this.selectedBot }),
                                days: this.selectedDays
                            })}`),
                            this.selectedBot ? fetch(`/api/analytics/recommendations/${this.selectedBot}`) : Promise.resolve({json: () => ({data: {recommendations: []}})})
                        ]);

                        const overviewData = await overviewResponse.json();
                        const timeData = await timeResponse.json();
                        const contentData = await contentResponse.json();
                        const recData = await recResponse.json();

                        this.overview = overviewData.data;
                        this.timeAnalysis = timeData.data;
                        this.contentAnalysis = contentData.data;
                        this.recommendations = recData.data?.recommendations || [];

                        // ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
                        this.updateCharts();

                    } catch (error) {
                        console.error('åˆ†æãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:', error);
                        alert('åˆ†æãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    } finally {
                        this.loading = false;
                    }
                },

                updateCharts() {
                    this.$nextTick(() => {
                        this.updateTimeChart();
                        this.updateTrendChart();
                    });
                },

                updateTimeChart() {
                    const ctx = document.getElementById('timeChart');
                    if (!ctx || !this.timeAnalysis) return;

                    if (this.timeChart) {
                        this.timeChart.destroy();
                    }

                    const hourlyData = this.timeAnalysis.hourly_data || [];
                    
                    this.timeChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: hourlyData.map(d => d.hour + 'æ™‚'),
                            datasets: [{
                                label: 'å¹³å‡ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ',
                                data: hourlyData.map(d => d.avg_engagement),
                                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                },

                updateTrendChart() {
                    const ctx = document.getElementById('trendChart');
                    if (!ctx) return;

                    if (this.trendChart) {
                        this.trendChart.destroy();
                    }

                    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã®ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ï¼‰
                    const labels = [];
                    const data = [];
                    
                    for (let i = this.selectedDays - 1; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        labels.push(date.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' }));
                        data.push(Math.floor(Math.random() * 100));
                    }

                    this.trendChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ',
                                data: data,
                                borderColor: 'rgba(34, 197, 94, 1)',
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            }
        }
    </script>
</body>
</html>